# Story 1.4: FastAPI Foundation & Initial Endpoints

## Status: Draft

## Assigned To: Mario

## Story

**As a** frontend developer,
**I want** REST API endpoints for health check and EDA summary,
**so that** I can verify the backend is operational.

## Acceptance Criteria

1. FastAPI app structured with routers in `backend/src/api/routers/`
2. `/health` GET endpoint returns `{ status: "healthy", version: "1.0.0", timestamp: "..." }`
3. `/api/v1/data/summary` GET endpoint returns dataset statistics (row count, segments, price range)
4. CORS configured for `http://localhost:3000` (frontend origin)
5. Request/response models defined with Pydantic in `backend/src/schemas/`
6. Basic error handling with appropriate HTTP status codes
7. Swagger documentation auto-generated at `/docs`

## Tasks / Subtasks

- [ ] Task 1: Set up FastAPI app structure (AC: 1)
  - [ ] Create `backend/src/api/__init__.py`
  - [ ] Create `backend/src/api/routers/__init__.py`
  - [ ] Create `backend/src/api/dependencies.py` for DI
  - [ ] Create `backend/src/api/middleware/__init__.py`
  - [ ] Update `backend/src/main.py` with app factory pattern

- [ ] Task 2: Implement health endpoint (AC: 2)
  - [ ] Create `backend/src/api/routers/health.py`
  - [ ] Implement `GET /health` returning HealthResponse
  - [ ] Include status, version (from config), timestamp

- [ ] Task 3: Create Pydantic schemas (AC: 5)
  - [ ] Create `backend/src/schemas/__init__.py`
  - [ ] Create `backend/src/schemas/health.py` with HealthResponse
  - [ ] Create `backend/src/schemas/data.py` with DataSummaryResponse

- [ ] Task 4: Implement data summary endpoint (AC: 3)
  - [ ] Create `backend/src/api/routers/data.py`
  - [ ] Implement `GET /api/v1/data/summary`
  - [ ] Return row_count, column_count, segments, price_range
  - [ ] Wire up preprocessor from Story 1.2

- [ ] Task 5: Configure CORS and middleware (AC: 4)
  - [ ] Add CORSMiddleware to app
  - [ ] Configure allowed origins: `http://localhost:3000`
  - [ ] Add logging middleware
  - [ ] Add request timing middleware

- [ ] Task 6: Implement error handling (AC: 6)
  - [ ] Create custom exception handlers
  - [ ] Return appropriate HTTP status codes (400, 404, 422, 500)
  - [ ] Create error response schema

- [ ] Task 7: Verify Swagger docs (AC: 7)
  - [ ] Ensure `/docs` shows all endpoints
  - [ ] Add descriptions to endpoints
  - [ ] Add example responses

- [ ] Task 8: Write integration tests
  - [ ] Test health endpoint
  - [ ] Test data summary endpoint
  - [ ] Test CORS headers

## Dev Notes

### API Structure (from docs/architecture/api-specification.md)
```
/health                  GET  → HealthResponse
/api/v1/data/summary     GET  → DataSummaryResponse
/api/v1/data/segment     POST → SegmentDetails (Story 1.5)
```

### Pydantic Schemas
```python
# schemas/health.py
class HealthResponse(BaseModel):
    status: Literal["healthy", "degraded", "unhealthy"]
    version: str
    timestamp: datetime

# schemas/data.py
class DataSummaryResponse(BaseModel):
    row_count: int
    column_count: int
    segments: list[str]
    price_range: dict[str, float]  # {"min": 5.0, "max": 150.0}
```

### CORS Configuration
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### FastAPI App Structure
```python
# main.py
from fastapi import FastAPI
from src.api.routers import health, data

def create_app() -> FastAPI:
    app = FastAPI(
        title="PrismIQ API",
        version="1.0.0",
        docs_url="/docs"
    )
    app.include_router(health.router)
    app.include_router(data.router, prefix="/api/v1")
    return app

app = create_app()
```

### Testing

- Test file: `backend/tests/integration/test_api/test_health.py`
- Test file: `backend/tests/integration/test_api/test_data.py`
- Use `httpx.AsyncClient` for async testing
- Verify response schemas match Pydantic models

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

