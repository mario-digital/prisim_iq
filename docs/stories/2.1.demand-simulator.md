# Story 2.1: Behavioral Demand Simulator

## Status: Draft

## Assigned To: Mario

## Story

**As a** data scientist,
**I want** a demand simulator that models realistic price-demand relationships,
**so that** I can generate training labels for ML models.

## Acceptance Criteria

1. Demand simulator implemented in `backend/src/ml/demand_simulator.py` with configurable elasticity
2. Demand modulated by: supply/demand ratio, time of day, segment, loyalty tier
3. Reference pricing effect included (anchoring to historical cost)
4. Segment-specific sensitivity parameters (e.g., Premium less elastic than Economy)
5. Function signature: `simulate_demand(context: MarketContext, price: float, elasticity_params: dict, external_factors: dict) -> float`
6. Demand values bounded realistically (0.0 to 1.0 probability scale or absolute units)
7. Unit tests validate: demand decreases as price increases (negative elasticity)

## Tasks / Subtasks

- [ ] Task 1: Create demand simulator module (AC: 1)
  - [ ] Create `backend/src/ml/demand_simulator.py`
  - [ ] Implement `DemandSimulator` class
  - [ ] Create configurable elasticity parameters structure

- [ ] Task 2: Implement base demand calculation (AC: 2, 6)
  - [ ] Calculate base demand from supply/demand ratio
  - [ ] Apply time-of-day modifier (peak vs off-peak)
  - [ ] Apply segment modifier
  - [ ] Apply loyalty tier modifier
  - [ ] Bound output to [0.0, 1.0]

- [ ] Task 3: Implement price sensitivity (AC: 1, 4)
  - [ ] Implement log-linear elasticity model
  - [ ] Create segment-specific elasticity parameters
  - [ ] Premium: -0.8 (less elastic), Economy: -1.2 (more elastic)
  - [ ] Load parameters from config

- [ ] Task 4: Add reference pricing effect (AC: 3)
  - [ ] Calculate deviation from historical_cost_of_ride
  - [ ] Apply anchoring effect (larger deviation = more demand impact)
  - [ ] Tune reference price sensitivity

- [ ] Task 5: Create elasticity config file (AC: 1, 4)
  - [ ] Create `backend/src/ml/config/elasticity.yaml`
  - [ ] Define parameters per segment and vehicle type
  - [ ] Document parameter meanings

- [ ] Task 6: Implement main simulation function (AC: 5)
  - [ ] Create `simulate_demand()` with specified signature
  - [ ] Accept external_factors dict for future n8n integration
  - [ ] Return demand probability/value

- [ ] Task 7: Write unit tests (AC: 7)
  - [ ] Test demand decreases as price increases
  - [ ] Test demand bounded in [0.0, 1.0]
  - [ ] Test segment-specific elasticity differences
  - [ ] Test reference pricing effect

## Dev Notes

### Demand Model Formula (Behavioral Economics)
```python
# Log-linear demand model
demand = base_demand * exp(elasticity * log(price / reference_price))

# With modifiers
base_demand = (
    supply_demand_modifier(context) *
    time_modifier(context.time_of_booking) *
    segment_modifier(context.segment) *
    loyalty_modifier(context.loyalty_status)
)

# Bounded output
final_demand = max(0.0, min(1.0, demand))
```

### Elasticity Parameters (Segment-Specific)
```yaml
# backend/src/ml/config/elasticity.yaml
elasticity:
  Urban_Peak_Premium: -0.7
  Urban_Peak_Economy: -1.0
  Urban_Standard_Premium: -0.8
  Urban_Standard_Economy: -1.2
  Suburban_Peak_Premium: -0.9
  Suburban_Standard_Economy: -1.3
  Rural_Standard_Economy: -1.5

modifiers:
  time:
    Morning: 0.9
    Afternoon: 0.85
    Evening: 1.1  # Peak demand
    Night: 0.7
  loyalty:
    Bronze: 1.0
    Silver: 1.05
    Gold: 1.1
    Platinum: 1.15
```

### Function Signature
```python
def simulate_demand(
    context: MarketContext,
    price: float,
    elasticity_params: dict | None = None,
    external_factors: dict | None = None
) -> float:
    """
    Simulate demand probability for given context and price.
    
    Args:
        context: Market context with all features
        price: Proposed price point
        elasticity_params: Override default elasticity (optional)
        external_factors: Weather, events, etc. from n8n (optional)
    
    Returns:
        Demand probability in [0.0, 1.0]
    """
```

### Testing

- Test file: `backend/tests/unit/test_ml/test_demand_simulator.py`
- Key test: `test_demand_decreases_with_price_increase`
- Key test: `test_premium_less_elastic_than_economy`
- Key test: `test_demand_bounded`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

