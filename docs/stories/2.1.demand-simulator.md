# Story 2.1: Behavioral Demand Simulator

## Status: Done

## Assigned To: Mario

## Story

**As a** data scientist,
**I want** a demand simulator that models realistic price-demand relationships,
**so that** I can generate training labels for ML models.

## Acceptance Criteria

1. Demand simulator implemented in `backend/src/ml/demand_simulator.py` with configurable elasticity
2. Demand modulated by: supply/demand ratio, time of day, segment, loyalty tier
3. Reference pricing effect included (anchoring to historical cost)
4. Segment-specific sensitivity parameters (e.g., Premium less elastic than Economy)
5. Function signature: `simulate_demand(context: MarketContext, price: float, elasticity_params: dict, external_factors: dict) -> float`
6. Demand values bounded realistically (0.0 to 1.0 probability scale or absolute units)
7. Unit tests validate: demand decreases as price increases (negative elasticity)

## Tasks / Subtasks

- [x] Task 1: Create demand simulator module (AC: 1)
  - [x] Create `backend/src/ml/demand_simulator.py`
  - [x] Implement `DemandSimulator` class
  - [x] Create configurable elasticity parameters structure

- [x] Task 2: Implement base demand calculation (AC: 2, 6)
  - [x] Calculate base demand from supply/demand ratio
  - [x] Apply time-of-day modifier (peak vs off-peak)
  - [x] Apply segment modifier
  - [x] Apply loyalty tier modifier
  - [x] Bound output to [0.0, 1.0]

- [x] Task 3: Implement price sensitivity (AC: 1, 4)
  - [x] Implement log-linear elasticity model
  - [x] Create segment-specific elasticity parameters
  - [x] Premium: -0.8 (less elastic), Economy: -1.2 (more elastic)
  - [x] Load parameters from config

- [x] Task 4: Add reference pricing effect (AC: 3)
  - [x] Calculate deviation from historical_cost_of_ride
  - [x] Apply anchoring effect (larger deviation = more demand impact)
  - [x] Tune reference price sensitivity

- [x] Task 5: Create elasticity config file (AC: 1, 4)
  - [x] Create `backend/src/ml/config/elasticity.yaml`
  - [x] Define parameters per segment and vehicle type
  - [x] Document parameter meanings

- [x] Task 6: Implement main simulation function (AC: 5)
  - [x] Create `simulate_demand()` with specified signature
  - [x] Accept external_factors dict for future n8n integration
  - [x] Return demand probability/value

- [x] Task 7: Write unit tests (AC: 7)
  - [x] Test demand decreases as price increases
  - [x] Test demand bounded in [0.0, 1.0]
  - [x] Test segment-specific elasticity differences
  - [x] Test reference pricing effect

## Dev Notes

### Demand Model Formula (Behavioral Economics)
```python
# Log-linear demand model
demand = base_demand * exp(elasticity * log(price / reference_price))

# With modifiers
base_demand = (
    supply_demand_modifier(context) *
    time_modifier(context.time_of_booking) *
    segment_modifier(context.segment) *
    loyalty_modifier(context.loyalty_status)
)

# Bounded output
final_demand = max(0.0, min(1.0, demand))
```

### Elasticity Parameters (Segment-Specific)
```yaml
# backend/src/ml/config/elasticity.yaml
elasticity:
  Urban_Peak_Premium: -0.7
  Urban_Peak_Economy: -1.0
  Urban_Standard_Premium: -0.8
  Urban_Standard_Economy: -1.2
  Suburban_Peak_Premium: -0.9
  Suburban_Standard_Economy: -1.3
  Rural_Standard_Economy: -1.5

modifiers:
  time:
    Morning: 0.9
    Afternoon: 0.85
    Evening: 1.1  # Peak demand
    Night: 0.7
  loyalty:
    Bronze: 1.0
    Silver: 1.05
    Gold: 1.1
    Platinum: 1.15
```

### Function Signature
```python
def simulate_demand(
    context: MarketContext,
    price: float,
    elasticity_params: dict | None = None,
    external_factors: dict | None = None
) -> float:
    """
    Simulate demand probability for given context and price.
    
    Args:
        context: Market context with all features
        price: Proposed price point
        elasticity_params: Override default elasticity (optional)
        external_factors: Weather, events, etc. from n8n (optional)
    
    Returns:
        Demand probability in [0.0, 1.0]
    """
```

### Testing

- Test file: `backend/tests/unit/test_ml/test_demand_simulator.py`
- Key test: `test_demand_decreases_with_price_increase`
- Key test: `test_premium_less_elastic_than_economy`
- Key test: `test_demand_bounded`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |
| 2025-12-02 | 1.1 | Implementation complete - demand simulator with all modifiers | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4 (via Cursor)

### Debug Log References
- `pytest tests/unit/test_ml/test_demand_simulator.py -v` â†’ 17 passed
- `pytest -v` â†’ 92 passed (full regression)
- `python -m py_compile src/ml/demand_simulator.py` â†’ Syntax OK

### Completion Notes List
1. **DemandSimulator class** - Full implementation with configurable elasticity via YAML config
2. **Log-linear demand model** - `demand = base_demand * exp(elasticity * log(price / reference_price))`
3. **Base demand modifiers** - Supply/demand ratio (sigmoid), time-of-day, segment location, loyalty tier
4. **Reference pricing effect** - Anchoring with configurable sensitivity (deviation from historical cost)
5. **Segment-specific elasticity** - Premium (-0.7 to -1.1) less elastic than Economy (-1.0 to -1.5)
6. **External factors support** - Weather and event_nearby multipliers for n8n integration
7. **Module-level function** - `simulate_demand()` convenience function using default singleton
8. **17 unit tests** - Covering all ACs: negative elasticity, bounds, segment differences, reference pricing

### File List
| File | Action | Description |
|------|--------|-------------|
| `backend/src/ml/demand_simulator.py` | Created | Main demand simulator module with DemandSimulator class |
| `backend/src/ml/config/elasticity.yaml` | Created | Elasticity config with segment parameters and modifiers |
| `backend/src/ml/__init__.py` | Modified | Added DemandSimulator and simulate_demand exports |
| `backend/tests/unit/test_ml/test_demand_simulator.py` | Created | 17 unit tests for demand simulator |

## QA Results

### Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** ðŸŸ¢

The implementation demonstrates strong software engineering practices:

1. **Clean Architecture**: Well-separated concerns with each demand modifier in its own method
2. **Documentation**: Excellent Google-style docstrings with Args/Returns/Raises throughout
3. **Type Safety**: Proper type hints with `TYPE_CHECKING` import guard for MarketContext
4. **Defensive Programming**: Edge case handling for invalid prices (â‰¤0) and missing reference prices
5. **Configuration Management**: YAML config with fallback defaults, well-documented parameter meanings
6. **Logging**: Appropriate log levels (info for init, debug for calculations)
7. **Testing**: Comprehensive 17 unit tests covering all ACs with good edge case coverage

### Refactoring Performed

Minor lint fixes applied during review:

- **File**: `backend/src/ml/demand_simulator.py`
  - **Change**: Combined nested `if` statements into single condition with `and`
  - **Why**: Ruff SIM102 - cleaner code structure
  - **How**: `if elasticity_params and "elasticity" in elasticity_params:`

- **File**: `backend/src/ml/demand_simulator.py`
  - **Change**: Converted if-else block to ternary operator
  - **Why**: Ruff SIM108 - more concise expression
  - **How**: `price_effect = math.exp(...) if price_ratio > 0 else 1.0`

- **File**: `backend/tests/unit/test_ml/test_demand_simulator.py`
  - **Change**: Removed unused `math` import and trailing whitespace
  - **Why**: Ruff F401/W293 - clean imports and formatting
  - **How**: Auto-fixed via `ruff check --fix`

### Compliance Check

- Coding Standards: âœ… Follows Python backend standards (loguru, type hints, docstrings)
- Project Structure: âœ… Correct location (`backend/src/ml/`), config in `config/` subfolder
- Testing Strategy: âœ… Unit tests in `tests/unit/test_ml/`, pytest conventions followed
- All ACs Met: âœ… All 7 acceptance criteria fully implemented and tested

### Requirements Traceability Matrix

| AC | Requirement | Test(s) | Coverage |
|----|-------------|---------|----------|
| 1 | Configurable elasticity | `test_simulator_initialization`, `test_elasticity_override` | Full |
| 2 | Modulated by supply/demand, time, segment, loyalty | `test_supply_demand_ratio_modifier`, `test_time_of_day_modifier`, `test_loyalty_modifier` | Full |
| 3 | Reference pricing (anchoring) | `test_reference_pricing_effect` | Full |
| 4 | Segment-specific elasticity | `test_premium_less_elastic_than_economy` | Full |
| 5 | Function signature | `test_simulate_demand_function`, `test_simulate_demand_with_params` | Full |
| 6 | Bounded [0.0, 1.0] | `test_demand_bounded_zero_to_one` | Full |
| 7 | Negative elasticity validation | `test_demand_decreases_with_price_increase` | Full |

### Improvements Checklist

All items handled - no outstanding improvements required:

- [x] All acceptance criteria implemented
- [x] All tests passing (17/17 unit, 92/92 regression)
- [x] Code follows project conventions
- [x] Config file well-documented
- [x] Module exports updated in `__init__.py`

### Security Review

**N/A** - This is a pure computational module with no auth, user data, or external inputs beyond typed parameters. No security concerns.

### Performance Considerations

**PASS** - All operations are O(1) mathematical calculations:
- Sigmoid function for supply/demand ratio
- Exponential calculations for elasticity
- Simple dictionary lookups for modifiers

No performance concerns for expected usage patterns (single demand calculations during price optimization).

### Files Modified During Review

| File | Change | Reason |
|------|--------|--------|
| `backend/src/ml/demand_simulator.py` | Lint fixes (SIM102, SIM108) | Ruff compliance |
| `backend/tests/unit/test_ml/test_demand_simulator.py` | Removed unused import, trailing whitespace | Ruff compliance (F401, W293) |

**Note**: Dev should update File List if tracking modifications.

### Test Verification

```
pytest tests/unit/test_ml/test_demand_simulator.py -v â†’ 17 passed âœ…
pytest -v â†’ 92 passed (full regression) âœ…
```

### Gate Status

Gate: **PASS** â†’ docs/qa/gates/2.1-behavioral-demand-simulator.yml

### Recommended Status

**âœ… Ready for Done**

All acceptance criteria met, comprehensive test coverage, excellent code quality. Story owner can mark as Done.

