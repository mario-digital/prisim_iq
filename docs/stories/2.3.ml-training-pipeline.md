# Story 2.3: ML Model Training Pipeline

## Status: Draft

## Assigned To: Mario

## Story

**As a** data scientist,
**I want** three ML models trained to predict demand,
**so that** I can compare performance and use the best predictor.

## Acceptance Criteria

1. Training pipeline in `backend/src/ml/training.py`
2. **Linear Regression** trained as interpretable baseline
3. **Decision Tree** trained with `max_depth` tuning (grid search 3-10)
4. **Random Forest** (or XGBoost) trained with GridSearchCV for hyperparameters
5. All models predict demand given context features + price as input
6. Models evaluated with: R², MAE, RMSE on test set
7. Comparison table generated and logged
8. Models serialized to `backend/data/models/*.joblib`

## Tasks / Subtasks

- [ ] Task 1: Create training pipeline structure (AC: 1)
  - [ ] Create `backend/src/ml/training.py`
  - [ ] Create `ModelTrainer` class
  - [ ] Load training data from Story 2.2

- [ ] Task 2: Implement Linear Regression (AC: 2)
  - [ ] Train sklearn LinearRegression
  - [ ] Extract coefficients for interpretability
  - [ ] Evaluate on test set

- [ ] Task 3: Implement Decision Tree (AC: 3)
  - [ ] Train sklearn DecisionTreeRegressor
  - [ ] GridSearchCV for max_depth in [3, 4, 5, 6, 7, 8, 9, 10]
  - [ ] Log best parameters

- [ ] Task 4: Implement XGBoost (AC: 4)
  - [ ] Train XGBRegressor
  - [ ] GridSearchCV for: max_depth, n_estimators, learning_rate
  - [ ] Log best parameters and feature importance

- [ ] Task 5: Create evaluation framework (AC: 6, 7)
  - [ ] Calculate R², MAE, RMSE for each model
  - [ ] Generate comparison table
  - [ ] Log results using loguru
  - [ ] Save metrics to JSON

- [ ] Task 6: Serialize models (AC: 8)
  - [ ] Save to `backend/data/models/linear_regression.joblib`
  - [ ] Save to `backend/data/models/decision_tree.joblib`
  - [ ] Save to `backend/data/models/xgboost.joblib`
  - [ ] Save feature names and preprocessing info

- [ ] Task 7: Create model manager (AC: 5)
  - [ ] Create `backend/src/ml/model_manager.py`
  - [ ] `ModelManager` class to load and serve models
  - [ ] `predict(context, price, model_name)` method
  - [ ] Support selecting model at runtime

- [ ] Task 8: Write tests
  - [ ] Test model training completes
  - [ ] Test predictions in valid range
  - [ ] Test model persistence

## Dev Notes

### Feature Set for Training
```python
features = [
    "number_of_riders",
    "number_of_drivers", 
    "supply_demand_ratio",
    "location_category_encoded",
    "customer_loyalty_status_encoded",
    "number_of_past_rides",
    "average_ratings",
    "time_of_booking_encoded",
    "vehicle_type_encoded",
    "expected_ride_duration",
    "historical_cost_of_ride",
    "segment_encoded",
    "price"  # The variable we're optimizing
]

target = "demand"
```

### Model Configurations
```python
# Linear Regression - baseline
linear_reg = LinearRegression()

# Decision Tree - tuned
dt_params = {"max_depth": [3, 4, 5, 6, 7, 8, 9, 10]}
decision_tree = GridSearchCV(
    DecisionTreeRegressor(random_state=42),
    dt_params,
    cv=5,
    scoring="neg_mean_squared_error"
)

# XGBoost - production model
xgb_params = {
    "max_depth": [3, 5, 7],
    "n_estimators": [50, 100, 200],
    "learning_rate": [0.01, 0.1, 0.2]
}
xgboost = GridSearchCV(
    XGBRegressor(random_state=42),
    xgb_params,
    cv=5,
    scoring="neg_mean_squared_error"
)
```

### ModelManager Interface
```python
class ModelManager:
    def __init__(self, models_dir: str = "data/models"):
        self.models = {}
        self._load_models()
    
    def predict(
        self, 
        context: MarketContext, 
        price: float,
        model_name: str = "xgboost"
    ) -> float:
        """Predict demand for context at given price"""
        
    def get_all_predictions(
        self,
        context: MarketContext,
        price: float
    ) -> dict[str, float]:
        """Get predictions from all models for comparison"""
```

### File Locations
- Training: `backend/src/ml/training.py`
- Model Manager: `backend/src/ml/model_manager.py`
- Models: `backend/data/models/*.joblib`
- Metrics: `backend/data/models/metrics.json`

### Testing

- Test file: `backend/tests/unit/test_ml/test_training.py`
- Test file: `backend/tests/unit/test_ml/test_model_manager.py`
- Test predictions are in [0, 1] range
- Test all three models can be loaded and predict

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

