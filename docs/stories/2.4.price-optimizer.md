# Story 2.4: Price Optimization Loop

## Status: Draft

## Assigned To: Mario

## Story

**As a** pricing analyst,
**I want** the system to find the profit-maximizing price,
**so that** I receive optimal recommendations.

## Acceptance Criteria

1. Optimization function in `backend/src/ml/price_optimizer.py`
2. Objective: Maximize `(price - cost) * predicted_demand(price)`
3. Price bounds configurable (default: $5 min, $200 max from Settings)
4. Returns: `optimal_price`, `expected_demand`, `expected_profit`, `profit_vs_baseline`
5. Baseline comparison using static historical price
6. Optimization completes in < 500ms per context
7. Unit tests verify optimizer finds known optimal on synthetic data

## Tasks / Subtasks

- [ ] Task 1: Create optimizer module (AC: 1)
  - [ ] Create `backend/src/ml/price_optimizer.py`
  - [ ] Create `PriceOptimizer` class
  - [ ] Inject ModelManager dependency

- [ ] Task 2: Implement objective function (AC: 2)
  - [ ] Define profit function: `(price - cost) * demand`
  - [ ] Create wrapper that calls model for demand prediction
  - [ ] Handle negative profit scenarios

- [ ] Task 3: Implement optimization loop (AC: 3, 6)
  - [ ] Use grid search at $0.50 increments within bounds
  - [ ] Or use scipy.optimize.minimize_scalar for faster convergence
  - [ ] Configurable price bounds (default $5 - $200)
  - [ ] Ensure < 500ms execution time

- [ ] Task 4: Create optimization result (AC: 4)
  - [ ] Return `OptimizationResult` dataclass/Pydantic model
  - [ ] Include: optimal_price, expected_demand, expected_profit
  - [ ] Include: price_demand_curve data for visualization

- [ ] Task 5: Implement baseline comparison (AC: 5)
  - [ ] Calculate profit at historical_cost_of_ride
  - [ ] Calculate profit_uplift_percent
  - [ ] Include in result

- [ ] Task 6: Add caching (AC: 6)
  - [ ] LRU cache for identical contexts
  - [ ] Cache key based on context hash
  - [ ] Configurable cache size

- [ ] Task 7: Write tests (AC: 7)
  - [ ] Test optimizer finds known optimal
  - [ ] Test execution time < 500ms
  - [ ] Test returns valid OptimizationResult

## Dev Notes

### Optimization Approach
```python
# Grid Search (simple, reliable)
def optimize_price(context: MarketContext) -> OptimizationResult:
    cost = context.historical_cost_of_ride
    prices = np.arange(5.0, 200.0, 0.50)  # $0.50 increments
    
    best_profit = -float('inf')
    best_price = cost
    
    for price in prices:
        demand = model_manager.predict(context, price)
        profit = (price - cost) * demand
        if profit > best_profit:
            best_profit = profit
            best_price = price
            best_demand = demand
    
    return OptimizationResult(
        optimal_price=best_price,
        expected_demand=best_demand,
        expected_profit=best_profit,
        ...
    )
```

### OptimizationResult Schema
```python
class OptimizationResult(BaseModel):
    optimal_price: float
    expected_demand: float
    expected_profit: float
    baseline_price: float
    baseline_profit: float
    profit_uplift_percent: float  # (optimal - baseline) / baseline * 100
    price_demand_curve: list[dict]  # For visualization
    optimization_time_ms: float
```

### Price-Demand Curve Data
```python
# For visualization - sample at key points
price_demand_curve = [
    {"price": 10.0, "demand": 0.95, "profit": 4.75},
    {"price": 20.0, "demand": 0.85, "profit": 12.75},
    {"price": 30.0, "demand": 0.70, "profit": 14.00},  # Optimal
    {"price": 40.0, "demand": 0.50, "profit": 10.00},
    {"price": 50.0, "demand": 0.30, "profit": 6.00},
]
```

### Caching Strategy
```python
from functools import lru_cache

@lru_cache(maxsize=1000)
def _cached_optimize(context_hash: str) -> OptimizationResult:
    ...

def optimize(context: MarketContext) -> OptimizationResult:
    context_hash = hash_context(context)
    return _cached_optimize(context_hash)
```

### Testing

- Test file: `backend/tests/unit/test_ml/test_price_optimizer.py`
- Test with known synthetic data where optimal is calculable
- Test performance: `assert optimization_time_ms < 500`
- Test profit_uplift_percent calculation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

