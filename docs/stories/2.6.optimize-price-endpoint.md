# Story 2.6: Optimize Price Endpoint

## Status: Draft

## Assigned To: Mario

## Story

**As a** frontend developer,
**I want** an API endpoint that returns optimized price recommendations,
**so that** the chat can display pricing guidance.

## Acceptance Criteria

1. `POST /api/v1/optimize_price` endpoint accepts MarketContext
2. Returns: `recommended_price`, `confidence_score`, `expected_profit`, `profit_uplift_percent`
3. Returns: segment assignment and model used for prediction
4. Returns: list of business rules applied with individual impacts
5. Response time < 3 seconds (including all ML inference)
6. Error handling for invalid contexts (422) and model errors (500)
7. Documented in Swagger with example request/response

## Tasks / Subtasks

- [ ] Task 1: Create pricing router (AC: 1)
  - [ ] Create `backend/src/api/routers/pricing.py`
  - [ ] Register router with `/api/v1` prefix
  - [ ] Add to main.py

- [ ] Task 2: Create PricingResult schema (AC: 2, 3, 4)
  - [ ] Create `backend/src/schemas/pricing.py`
  - [ ] Define `PricingResult` with all required fields
  - [ ] Add Swagger examples

- [ ] Task 3: Create PricingService (AC: 1-5)
  - [ ] Create `backend/src/services/pricing_service.py`
  - [ ] Orchestrate: Segmenter → ModelManager → Optimizer → RulesEngine
  - [ ] Return complete PricingResult

- [ ] Task 4: Implement endpoint (AC: 1, 5)
  - [ ] `POST /api/v1/optimize_price`
  - [ ] Accept MarketContext body
  - [ ] Call PricingService
  - [ ] Ensure < 3 second response

- [ ] Task 5: Add error handling (AC: 6)
  - [ ] Validate input (422 for bad data)
  - [ ] Handle model errors (500)
  - [ ] Graceful degradation if components fail

- [ ] Task 6: Add Swagger documentation (AC: 7)
  - [ ] Detailed endpoint description
  - [ ] Example request body
  - [ ] Example response

- [ ] Task 7: Write integration tests
  - [ ] Test valid request returns PricingResult
  - [ ] Test invalid input returns 422
  - [ ] Test response time < 3 seconds

## Dev Notes

### PricingResult Schema
```python
class PricingResult(BaseModel):
    # Core recommendation
    recommended_price: float
    confidence_score: float  # 0.0 - 1.0
    
    # Profit metrics
    expected_demand: float
    expected_profit: float
    baseline_profit: float
    profit_uplift_percent: float
    
    # Context info
    segment: SegmentDetails
    model_used: str  # "xgboost", "decision_tree", etc.
    
    # Rules applied
    rules_applied: list[AppliedRule]
    price_before_rules: float
    
    # Visualization data
    price_demand_curve: list[PriceDemandPoint]
    
    # Metadata
    processing_time_ms: float
    timestamp: datetime
```

### PricingService Architecture
```python
class PricingService:
    def __init__(
        self,
        segmenter: Segmenter,
        model_manager: ModelManager,
        optimizer: PriceOptimizer,
        rules_engine: RulesEngine
    ):
        ...
    
    async def get_recommendation(
        self, 
        context: MarketContext
    ) -> PricingResult:
        # 1. Classify segment
        segment = self.segmenter.classify(context)
        
        # 2. Run optimization
        optimization = self.optimizer.optimize(context)
        
        # 3. Apply business rules
        rules_result = self.rules_engine.apply(
            context, 
            optimization.optimal_price
        )
        
        # 4. Compile result
        return PricingResult(
            recommended_price=rules_result.final_price,
            ...
        )
```

### Dependency Injection
```python
# api/dependencies.py
def get_pricing_service() -> PricingService:
    return PricingService(
        segmenter=get_segmenter(),
        model_manager=get_model_manager(),
        optimizer=get_optimizer(),
        rules_engine=get_rules_engine()
    )
```

### Performance Target
- Total response time < 3 seconds
- Segment classification: < 100ms
- ML prediction: < 500ms
- Optimization: < 500ms
- Rules: < 100ms
- Buffer for network/serialization

### Testing

- Test file: `backend/tests/integration/test_api/test_pricing.py`
- Test with valid MarketContext
- Assert all fields present in response
- Assert response time < 3000ms

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

