# Story 2.7: External Data Integration via n8n

## Status: Draft

## Assigned To: Mario

## Story

**As a** pricing analyst,
**I want** real-time external data factored into recommendations,
**so that** pricing reflects current market conditions.

## Acceptance Criteria

1. n8n instance configuration documented (localhost:5678)
2. **Fuel Price Workflow:** Fetches current fuel prices → impacts cost basis
3. **Weather Workflow:** Fetches weather conditions → impacts demand modifier
4. **Events Workflow:** Fetches local events → impacts surge factor
5. Each workflow exposes webhook endpoint (POST)
6. External data cached with TTL (weather 30min, events 1hr, traffic 5min)
7. Demand simulator accepts external modifiers from n8n data
8. `GET /api/v1/external_context` endpoint returns current external factors
9. Agent can articulate external factors in natural language explanations

## Tasks / Subtasks

- [ ] Task 1: Create external service module (AC: 1)
  - [ ] Create `backend/src/services/external_service.py`
  - [ ] Create `ExternalDataService` class
  - [ ] Document n8n setup in README

- [ ] Task 2: Implement caching layer (AC: 6)
  - [ ] Create file-based JSON cache
  - [ ] Implement TTL per data type
  - [ ] Weather: 30 min TTL
  - [ ] Events: 1 hour TTL
  - [ ] Fuel: 1 hour TTL

- [ ] Task 3: Create mock external data (AC: 2, 3, 4)
  - [ ] Create mock fuel price data
  - [ ] Create mock weather data
  - [ ] Create mock events data
  - [ ] Use mocks when n8n unavailable

- [ ] Task 4: Implement fuel price integration (AC: 2)
  - [ ] Create webhook handler for fuel prices
  - [ ] Apply fuel cost modifier to baseline cost
  - [ ] Document n8n workflow setup

- [ ] Task 5: Implement weather integration (AC: 3)
  - [ ] Create webhook handler for weather
  - [ ] Map weather conditions to demand modifiers
  - [ ] Rainy: +15% demand, Sunny: baseline, Snow: +30% demand

- [ ] Task 6: Implement events integration (AC: 4, 5)
  - [ ] Create webhook handler for events
  - [ ] Map event types to surge factors
  - [ ] Concert: +20%, Sports: +25%, Convention: +15%

- [ ] Task 7: Update demand simulator (AC: 7)
  - [ ] Modify `simulate_demand()` to accept external_factors
  - [ ] Apply weather modifier
  - [ ] Apply event modifier

- [ ] Task 8: Create external context endpoint (AC: 8)
  - [ ] `GET /api/v1/external_context`
  - [ ] Return current cached external factors
  - [ ] Include cache ages and freshness

- [ ] Task 9: Create explanation helpers (AC: 9)
  - [ ] Generate natural language descriptions
  - [ ] "Current weather (rainy) is increasing demand by 15%"
  - [ ] "Nearby concert event is adding 20% surge factor"

- [ ] Task 10: Write tests
  - [ ] Test caching with TTL
  - [ ] Test fallback to mocks
  - [ ] Test external context endpoint

## Dev Notes

### External Data Schema
```python
class ExternalContext(BaseModel):
    fuel: FuelData | None
    weather: WeatherData | None
    events: list[EventData]
    last_updated: datetime
    
class FuelData(BaseModel):
    price_per_gallon: float
    change_percent: float  # vs yesterday
    source: str
    fetched_at: datetime
    
class WeatherData(BaseModel):
    condition: Literal["sunny", "cloudy", "rainy", "snowy"]
    temperature_f: float
    demand_modifier: float  # e.g., 1.15 for rainy
    source: str
    fetched_at: datetime
    
class EventData(BaseModel):
    name: str
    type: Literal["concert", "sports", "convention", "other"]
    venue: str
    start_time: datetime
    surge_modifier: float  # e.g., 1.20
    radius_miles: float
```

### Demand Modifier Application
```python
# In demand_simulator.py
def simulate_demand(
    context: MarketContext,
    price: float,
    elasticity_params: dict | None = None,
    external_factors: ExternalContext | None = None
) -> float:
    base_demand = calculate_base_demand(context, price, elasticity_params)
    
    if external_factors:
        if external_factors.weather:
            base_demand *= external_factors.weather.demand_modifier
        for event in external_factors.events:
            base_demand *= event.surge_modifier
    
    return min(1.0, max(0.0, base_demand))
```

### Caching Implementation
```python
# File-based cache at backend/data/cache/
cache_files = {
    "fuel": "fuel_cache.json",
    "weather": "weather_cache.json",
    "events": "events_cache.json"
}

cache_ttl = {
    "fuel": timedelta(hours=1),
    "weather": timedelta(minutes=30),
    "events": timedelta(hours=1)
}
```

### n8n Webhook Endpoints (Documentation)
```
POST http://localhost:5678/webhook/fuel-prices
POST http://localhost:5678/webhook/weather
POST http://localhost:5678/webhook/events
```

### Fallback Behavior
When n8n unavailable, use neutral defaults:
- Fuel: Use baseline cost (no adjustment)
- Weather: Assume "cloudy" (1.0 modifier)
- Events: Empty list (no surge)

### Testing

- Test file: `backend/tests/unit/test_services/test_external_service.py`
- Test cache expiration
- Test fallback to mocks
- Test modifier application

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

