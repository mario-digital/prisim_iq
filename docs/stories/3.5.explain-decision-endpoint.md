# Story 3.5: Explain Decision Endpoint

## Status: Draft

## Assigned To: Mario

## Story

**As a** frontend developer,
**I want** an API endpoint returning full explanation,
**so that** UI can display "why" information alongside recommendations.

## Acceptance Criteria

1. `POST /api/v1/explain_decision` endpoint accepts MarketContext + optional pricing result reference
2. Returns: `recommendation`, `feature_importance[]`, `decision_trace`, `natural_language_summary`, `model_agreement`
3. Natural language summary generated (e.g., "The recommended price of $42.50 is primarily driven by high demand in your urban segment during evening hours...")
4. Response time < 2 seconds
5. Documented in Swagger with comprehensive examples

## Tasks / Subtasks

- [ ] Task 1: Create explanation router (AC: 1)
  - [ ] Add to `backend/src/api/routers/explain.py`
  - [ ] Register with `/api/v1` prefix
  - [ ] Define request schema

- [ ] Task 2: Create PriceExplanation schema (AC: 2)
  - [ ] Create `backend/src/schemas/explanation.py`
  - [ ] Include all required fields
  - [ ] Add Swagger examples

- [ ] Task 3: Implement explanation service (AC: 2)
  - [ ] Create `backend/src/services/explanation_service.py`
  - [ ] Orchestrate feature importance calculation
  - [ ] Generate decision trace
  - [ ] Calculate model agreement

- [ ] Task 4: Implement natural language generation (AC: 3)
  - [ ] Template-based narrative generation
  - [ ] Include top factors
  - [ ] Contextual descriptions

- [ ] Task 5: Implement endpoint (AC: 1, 4)
  - [ ] POST /api/v1/explain_decision
  - [ ] Accept MarketContext
  - [ ] Optionally accept previous pricing_result_id
  - [ ] Ensure < 2 second response

- [ ] Task 6: Add Swagger documentation (AC: 5)
  - [ ] Detailed descriptions
  - [ ] Full example request/response
  - [ ] Error documentation

- [ ] Task 7: Write tests
  - [ ] Test valid explanation returned
  - [ ] Test natural language summary generated
  - [ ] Test response time < 2 seconds

## Dev Notes

### PriceExplanation Schema
```python
class ExplainRequest(BaseModel):
    context: MarketContext
    pricing_result_id: str | None = None  # Reference previous result
    include_trace: bool = True
    include_shap: bool = True
    
class PriceExplanation(BaseModel):
    # Core recommendation (may be recalculated or referenced)
    recommendation: PricingResult
    
    # Feature importance
    feature_importance: list[FeatureContribution]
    global_importance: list[FeatureContribution]  # Model-level
    
    # Decision trace
    decision_trace: DecisionTrace
    
    # Model comparison
    model_agreement: ModelAgreement
    model_predictions: dict[str, float]
    
    # Natural language
    natural_language_summary: str
    key_factors: list[str]  # ["High demand", "Evening peak", "Premium vehicle"]
    
    # Metadata
    explanation_time_ms: float
    timestamp: datetime
```

### Natural Language Generation
```python
def generate_narrative(
    result: PricingResult,
    importance: list[FeatureContribution],
    context: MarketContext
) -> str:
    """
    Generate human-readable explanation.
    Template-based, NOT LLM-generated (for speed).
    """
    top_factors = importance[:3]
    
    narrative = f"The recommended price of ${result.recommended_price:.2f} "
    
    # Add primary driver
    primary = top_factors[0]
    narrative += f"is primarily driven by {primary.description.lower()} "
    narrative += f"(contributing {primary.importance*100:.0f}% to the decision). "
    
    # Add secondary factors
    if len(top_factors) > 1:
        secondary = [f.display_name.lower() for f in top_factors[1:]]
        narrative += f"Additional factors include {' and '.join(secondary)}. "
    
    # Add profit context
    narrative += f"This price is expected to generate ${result.expected_profit:.2f} "
    narrative += f"in profit, a {result.profit_uplift_percent:.1f}% improvement "
    narrative += "over the baseline price."
    
    return narrative

# Example output:
# "The recommended price of $42.50 is primarily driven by high demand-to-supply 
# ratio (contributing 32% to the decision). Additional factors include evening 
# peak hours and premium vehicle selection. This price is expected to generate 
# $18.75 in profit, a 24.3% improvement over the baseline price."
```

### Endpoint Implementation
```python
@router.post("/explain_decision", response_model=PriceExplanation)
async def explain_decision(
    request: ExplainRequest,
    explanation_service: ExplanationService = Depends(get_explanation_service)
) -> PriceExplanation:
    return await explanation_service.explain(request)
```

### Performance Target
- Total response time < 2 seconds
- Feature importance: < 500ms
- Decision trace: < 500ms
- Natural language: < 100ms

### Testing

- Test file: `backend/tests/integration/test_api/test_explain.py`
- Test all fields present in response
- Test natural_language_summary is non-empty string
- Test response time < 2000ms

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

