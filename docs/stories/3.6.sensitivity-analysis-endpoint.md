# Story 3.6: Sensitivity Analysis Endpoint

## Status: Draft

## Assigned To: Mario

## Story

**As a** frontend developer,
**I want** an API endpoint for sensitivity analysis,
**so that** UI can display robustness charts.

## Acceptance Criteria

1. `POST /api/v1/sensitivity_analysis` endpoint accepts MarketContext
2. Returns: `elasticity_sensitivity[]`, `demand_sensitivity[]`, `cost_sensitivity[]`
3. Returns: `confidence_band` (min/max price range) and `robustness_score` (0-100)
4. Response time < 3 seconds (parallel scenario calculation)
5. Documented in Swagger with chart-ready response format

## Tasks / Subtasks

- [ ] Task 1: Create sensitivity router (AC: 1)
  - [ ] Add to `backend/src/api/routers/sensitivity.py`
  - [ ] Register with `/api/v1` prefix

- [ ] Task 2: Create response schema (AC: 2, 3)
  - [ ] Create `backend/src/schemas/sensitivity.py`
  - [ ] Define chart-ready array formats
  - [ ] Include confidence band

- [ ] Task 3: Implement endpoint (AC: 1, 4)
  - [ ] POST /api/v1/sensitivity_analysis
  - [ ] Call SensitivityService from Story 3.3
  - [ ] Ensure < 3 second response

- [ ] Task 4: Format response for charts (AC: 2)
  - [ ] Structure arrays for Recharts consumption
  - [ ] Include x/y values for plotting
  - [ ] Add labels for tooltips

- [ ] Task 5: Add Swagger documentation (AC: 5)
  - [ ] Document all response fields
  - [ ] Provide chart integration examples
  - [ ] Document array formats

- [ ] Task 6: Write tests
  - [ ] Test endpoint returns all arrays
  - [ ] Test confidence band calculated
  - [ ] Test response time < 3 seconds

## Dev Notes

### API Response Schema (Chart-Ready)
```python
class SensitivityResponse(BaseModel):
    # Base reference
    base_context: MarketContextSummary
    base_price: float
    base_profit: float
    
    # Sensitivity arrays (Recharts-ready)
    elasticity_sensitivity: list[SensitivityPoint]
    demand_sensitivity: list[SensitivityPoint]
    cost_sensitivity: list[SensitivityPoint]
    
    # Confidence metrics
    confidence_band: ConfidenceBand
    robustness_score: float
    
    # Extremes
    worst_case: ScenarioSummary
    best_case: ScenarioSummary
    
    # Metadata
    scenarios_calculated: int
    processing_time_ms: float
    
class SensitivityPoint(BaseModel):
    """Single point for sensitivity chart"""
    x: float  # Modifier value (e.g., 0.8, 1.0, 1.2)
    y: float  # Resulting price
    label: str  # "-20%", "Base", "+20%"
    profit: float
    demand: float
    
class ConfidenceBand(BaseModel):
    min_price: float
    max_price: float
    range: float
    range_percent: float
    
class ScenarioSummary(BaseModel):
    scenario_name: str
    scenario_type: str
    price: float
    profit: float
    description: str  # "20% higher elasticity reduces optimal price to $38.50"
```

### Response Format for Recharts
```json
{
  "elasticity_sensitivity": [
    {"x": 0.7, "y": 48.50, "label": "-30%", "profit": 22.10, "demand": 0.68},
    {"x": 0.8, "y": 45.00, "label": "-20%", "profit": 20.50, "demand": 0.72},
    {"x": 0.9, "y": 43.50, "label": "-10%", "profit": 19.20, "demand": 0.75},
    {"x": 1.0, "y": 42.50, "label": "Base", "profit": 18.75, "demand": 0.78},
    {"x": 1.1, "y": 40.50, "label": "+10%", "profit": 17.80, "demand": 0.82},
    {"x": 1.2, "y": 38.50, "label": "+20%", "profit": 16.90, "demand": 0.85},
    {"x": 1.3, "y": 36.50, "label": "+30%", "profit": 16.10, "demand": 0.88}
  ],
  "confidence_band": {
    "min_price": 32.00,
    "max_price": 52.00,
    "range": 20.00,
    "range_percent": 47.06
  },
  "robustness_score": 53
}
```

### Endpoint Implementation
```python
@router.post("/sensitivity_analysis", response_model=SensitivityResponse)
async def sensitivity_analysis(
    context: MarketContext,
    sensitivity_service: SensitivityService = Depends(get_sensitivity_service)
) -> SensitivityResponse:
    result = await sensitivity_service.analyze(context)
    return format_for_charts(result)
```

### Recharts Integration Example
```tsx
// Frontend usage
<LineChart data={response.elasticity_sensitivity}>
  <XAxis dataKey="label" />
  <YAxis />
  <Line type="monotone" dataKey="y" name="Price" />
  <Tooltip formatter={(value, name, props) => 
    [`$${value}`, `Profit: $${props.payload.profit}`]
  } />
</LineChart>
```

### Testing

- Test file: `backend/tests/integration/test_api/test_sensitivity.py`
- Test elasticity_sensitivity has 7 points
- Test demand_sensitivity has 5 points
- Test cost_sensitivity has 5 points
- Test robustness_score in [0, 100]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

