# Story 4.10: Visualizations & Charts

## Status: Draft

## Assigned To: David

## Story

**As a** pricing analyst,
**I want** interactive, professional charts,
**so that** I can visually understand pricing dynamics.

## Acceptance Criteria

1. Recharts library integrated and configured with custom theme
2. **Feature Importance:** Horizontal bar chart with sorted bars, value labels
3. **Demand Curve:** Line chart with optimal price point marker
4. **Profit Curve:** Line chart with area fill under curve, max profit marker
5. **Segment Performance:** Grouped bar chart comparing segments
6. **Sensitivity Band:** Area chart showing confidence intervals
7. All charts responsive (resize with container)
8. Consistent color palette across all visualizations

## Tasks / Subtasks

- [ ] Task 1: Configure Recharts theming (AC: 1, 8)
  - [ ] Install Recharts if not already
  - [ ] Create `frontend/src/lib/chartTheme.ts`
  - [ ] Define color palette matching app theme
  - [ ] Create reusable chart config

- [ ] Task 2: Create chart components directory
  - [ ] Organize under `frontend/src/components/visualizations/charts/`
  - [ ] Create shared chart utilities

- [ ] Task 3: Enhance Feature Importance chart (AC: 2)
  - [ ] Improve `FeatureImportanceChart.tsx` from Story 4.4
  - [ ] Add value labels on bars
  - [ ] Sort by importance descending
  - [ ] Add tooltips with details

- [ ] Task 4: Create Demand Curve chart (AC: 3)
  - [ ] Create/enhance `DemandCurveChart.tsx`
  - [ ] Add optimal price marker (dot + label)
  - [ ] Add current price indicator
  - [ ] Smooth curve interpolation

- [ ] Task 5: Create Profit Curve chart (AC: 4)
  - [ ] Create/enhance `ProfitCurveChart.tsx`
  - [ ] Add gradient area fill
  - [ ] Mark maximum profit point
  - [ ] Show profit value at marker

- [ ] Task 6: Create Segment Performance chart (AC: 5)
  - [ ] Create `SegmentPerformanceChart.tsx`
  - [ ] Grouped bar chart by segment
  - [ ] Compare baseline vs optimized
  - [ ] Add legend

- [ ] Task 7: Create Sensitivity Band chart (AC: 6)
  - [ ] Create `SensitivityBandChart.tsx`
  - [ ] Area chart with confidence bands
  - [ ] Show min/max price range
  - [ ] Mark base price

- [ ] Task 8: Ensure responsiveness (AC: 7)
  - [ ] Use ResponsiveContainer for all charts
  - [ ] Test at different viewport sizes
  - [ ] Handle panel collapse/expand

- [ ] Task 9: Add chart animations
  - [ ] Subtle entry animations
  - [ ] Smooth transitions on data change
  - [ ] Polish interactions

## Dev Notes

### Component Structure
```
frontend/src/components/visualizations/charts/
├── index.ts                      # Exports
├── FeatureImportanceChart.tsx    # Horizontal bar
├── DemandCurveChart.tsx          # Line with marker
├── ProfitCurveChart.tsx          # Area with marker
├── SegmentPerformanceChart.tsx   # Grouped bar
├── SensitivityBandChart.tsx      # Area with bands
└── shared/
    ├── ChartTooltip.tsx          # Custom tooltip
    ├── ChartLegend.tsx           # Custom legend
    └── chartUtils.ts             # Formatting helpers
```

### Chart Theme Configuration
```typescript
// lib/chartTheme.ts
export const chartColors = {
  primary: '#3b82f6',     // Blue
  secondary: '#10b981',   // Green
  accent: '#f59e0b',      // Amber
  muted: '#94a3b8',       // Slate
  positive: '#22c55e',    // Green
  negative: '#ef4444',    // Red
  gradient: {
    start: 'rgba(59, 130, 246, 0.3)',
    end: 'rgba(59, 130, 246, 0)',
  }
};

export const chartConfig = {
  margin: { top: 20, right: 20, bottom: 20, left: 20 },
  fontSize: 12,
  fontFamily: 'Inter, system-ui, sans-serif',
};
```

### Feature Importance Chart (Enhanced)
```tsx
// FeatureImportanceChart.tsx
import { BarChart, Bar, XAxis, YAxis, Tooltip, Cell, LabelList, ResponsiveContainer } from 'recharts';

export function FeatureImportanceChart({ data }: Props) {
  const sortedData = [...data]
    .sort((a, b) => b.importance - a.importance)
    .slice(0, 6)
    .map(d => ({
      ...d,
      value: d.importance * 100,
      color: d.direction === 'positive' ? chartColors.positive : chartColors.negative,
    }));

  return (
    <ResponsiveContainer width="100%" height={220}>
      <BarChart data={sortedData} layout="vertical" margin={chartConfig.margin}>
        <XAxis 
          type="number" 
          domain={[0, 100]} 
          tickFormatter={(v) => `${v}%`}
          fontSize={chartConfig.fontSize}
        />
        <YAxis 
          type="category" 
          dataKey="display_name" 
          width={120}
          fontSize={chartConfig.fontSize}
        />
        <Tooltip 
          content={<CustomTooltip />}
          cursor={{ fill: 'rgba(0,0,0,0.05)' }}
        />
        <Bar dataKey="value" radius={[0, 4, 4, 0]}>
          {sortedData.map((entry, index) => (
            <Cell key={index} fill={entry.color} />
          ))}
          <LabelList 
            dataKey="value" 
            position="right" 
            formatter={(v: number) => `${v.toFixed(1)}%`}
            fontSize={11}
          />
        </Bar>
      </BarChart>
    </ResponsiveContainer>
  );
}
```

### Demand Curve Chart
```tsx
// DemandCurveChart.tsx
import { LineChart, Line, XAxis, YAxis, Tooltip, ReferenceDot, ResponsiveContainer } from 'recharts';

export function DemandCurveChart({ data, optimalPrice, currentPrice }: Props) {
  const optimalPoint = data.find(d => Math.abs(d.price - optimalPrice) < 0.5);
  
  return (
    <ResponsiveContainer width="100%" height={200}>
      <LineChart data={data} margin={chartConfig.margin}>
        <XAxis 
          dataKey="price" 
          tickFormatter={(v) => `$${v}`}
          fontSize={chartConfig.fontSize}
        />
        <YAxis 
          tickFormatter={(v) => `${(v * 100).toFixed(0)}%`}
          domain={[0, 1]}
          fontSize={chartConfig.fontSize}
        />
        <Tooltip 
          formatter={(v: number) => [`${(v * 100).toFixed(1)}%`, 'Demand']}
          labelFormatter={(v) => `Price: $${v}`}
        />
        <Line 
          type="monotone" 
          dataKey="demand" 
          stroke={chartColors.primary}
          strokeWidth={2}
          dot={false}
          activeDot={{ r: 6 }}
        />
        {optimalPoint && (
          <ReferenceDot 
            x={optimalPoint.price} 
            y={optimalPoint.demand}
            r={8}
            fill={chartColors.secondary}
            stroke="#fff"
            strokeWidth={2}
          />
        )}
      </LineChart>
    </ResponsiveContainer>
  );
}
```

### Profit Curve with Area Fill
```tsx
// ProfitCurveChart.tsx
export function ProfitCurveChart({ data, optimalPrice }: Props) {
  const maxProfit = Math.max(...data.map(d => d.profit));
  const optimalPoint = data.find(d => d.profit === maxProfit);
  
  return (
    <ResponsiveContainer width="100%" height={200}>
      <AreaChart data={data} margin={chartConfig.margin}>
        <defs>
          <linearGradient id="profitGradient" x1="0" y1="0" x2="0" y2="1">
            <stop offset="5%" stopColor={chartColors.primary} stopOpacity={0.3}/>
            <stop offset="95%" stopColor={chartColors.primary} stopOpacity={0}/>
          </linearGradient>
        </defs>
        <XAxis dataKey="price" tickFormatter={(v) => `$${v}`} />
        <YAxis tickFormatter={(v) => `$${v}`} />
        <Tooltip />
        <Area 
          type="monotone" 
          dataKey="profit" 
          stroke={chartColors.primary}
          fill="url(#profitGradient)"
          strokeWidth={2}
        />
        {optimalPoint && (
          <ReferenceDot 
            x={optimalPoint.price} 
            y={optimalPoint.profit}
            r={8}
            fill={chartColors.secondary}
            stroke="#fff"
            label={{ value: `Max: $${optimalPoint.profit.toFixed(2)}`, position: 'top' }}
          />
        )}
      </AreaChart>
    </ResponsiveContainer>
  );
}
```

### Sensitivity Band Chart
```tsx
// SensitivityBandChart.tsx
export function SensitivityBandChart({ data, basePrice }: Props) {
  return (
    <ResponsiveContainer width="100%" height={200}>
      <AreaChart data={data} margin={chartConfig.margin}>
        <XAxis dataKey="scenario" />
        <YAxis tickFormatter={(v) => `$${v}`} />
        <Tooltip />
        <Area 
          type="monotone"
          dataKey="maxPrice"
          stroke="transparent"
          fill={chartColors.primary}
          fillOpacity={0.2}
        />
        <Area 
          type="monotone"
          dataKey="minPrice"
          stroke="transparent"
          fill="#fff"
        />
        <Line 
          type="monotone"
          dataKey="price"
          stroke={chartColors.primary}
          strokeWidth={2}
        />
        <ReferenceLine y={basePrice} stroke={chartColors.muted} strokeDasharray="3 3" />
      </AreaChart>
    </ResponsiveContainer>
  );
}
```

### Testing

- Test file: `frontend/tests/unit/visualizations/charts/`
- Test charts render without error
- Test responsive behavior
- Test with mock data

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

