# Story 4.2: Analyst Workspace - Left Panel (Context)

## Status: Draft

## Assigned To: Grace

## Story

**As a** pricing analyst,
**I want** to see and modify market context,
**so that** I can explore different pricing scenarios.

## Acceptance Criteria

1. Left panel displays all context sections: Location, Time, Supply/Demand, Customer, Vehicle
2. All context values editable via appropriate inputs (dropdowns, sliders, number inputs)
3. "Apply Changes" button triggers price recalculation
4. Scenario Controls section with quick-adjust sliders
5. Saved Scenarios list with save/load/delete functionality
6. Panel collapse functionality (chevron toggle)
7. State persisted in localStorage across sessions

## Tasks / Subtasks

- [ ] Task 1: Create context components directory (AC: 1)
  - [ ] Create `frontend/src/components/context/` directory
  - [ ] Create `ContextPanel.tsx` main component
  - [ ] Plan section structure

- [ ] Task 2: Create Location section (AC: 1, 2)
  - [ ] Create `LocationSection.tsx`
  - [ ] Dropdown for Location_Category (Urban/Suburban/Rural)
  - [ ] Display current selection

- [ ] Task 3: Create Time section (AC: 1, 2)
  - [ ] Create `TimeSection.tsx`
  - [ ] Dropdown for Time_of_Booking (Morning/Afternoon/Evening/Night)
  - [ ] Optional: time picker visualization

- [ ] Task 4: Create Supply/Demand section (AC: 1, 2, 4)
  - [ ] Create `SupplyDemandSection.tsx`
  - [ ] Number input for Number_of_Riders
  - [ ] Number input for Number_of_Drivers
  - [ ] Display calculated supply/demand ratio
  - [ ] Quick-adjust slider for ratio

- [ ] Task 5: Create Customer section (AC: 1, 2)
  - [ ] Create `CustomerSection.tsx`
  - [ ] Dropdown for Customer_Loyalty_Status
  - [ ] Number input for Number_of_Past_Rides
  - [ ] Number input for Average_Ratings (1-5 with 0.1 steps)

- [ ] Task 6: Create Vehicle section (AC: 1, 2)
  - [ ] Create `VehicleSection.tsx`
  - [ ] Dropdown for Vehicle_Type (Economy/Premium)
  - [ ] Number input for Expected_Ride_Duration
  - [ ] Number input for Historical_Cost_of_Ride

- [ ] Task 7: Create Apply Changes functionality (AC: 3)
  - [ ] Create "Apply Changes" button
  - [ ] Trigger API call to optimize_price
  - [ ] Update global state with new recommendation
  - [ ] Show loading state during API call

- [ ] Task 8: Create Scenario Management (AC: 5)
  - [ ] Create `ScenarioManager.tsx`
  - [ ] Save current context as named scenario
  - [ ] List saved scenarios
  - [ ] Load scenario on click
  - [ ] Delete scenario option

- [ ] Task 9: Create context store (AC: 7)
  - [ ] Create `frontend/src/stores/contextStore.ts`
  - [ ] Persist to localStorage
  - [ ] Include saved scenarios array

- [ ] Task 10: Integrate with layout (AC: 6)
  - [ ] Import into LeftPanel from Story 4.1
  - [ ] Ensure collapse functionality works
  - [ ] Responsive styling

## Dev Notes

### Component Structure
```
frontend/src/components/context/
├── ContextPanel.tsx          # Main container
├── LocationSection.tsx       # Location category dropdown
├── TimeSection.tsx           # Time of booking
├── SupplyDemandSection.tsx   # Riders/Drivers/Ratio
├── CustomerSection.tsx       # Loyalty, past rides, ratings
├── VehicleSection.tsx        # Vehicle type, duration, cost
├── ScenarioControls.tsx      # Quick-adjust sliders
└── ScenarioManager.tsx       # Save/load/delete scenarios
```

### Context Store (Zustand)
```typescript
// stores/contextStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface MarketContext {
  number_of_riders: number;
  number_of_drivers: number;
  location_category: 'Urban' | 'Suburban' | 'Rural';
  customer_loyalty_status: 'Bronze' | 'Silver' | 'Gold' | 'Platinum';
  number_of_past_rides: number;
  average_ratings: number;
  time_of_booking: 'Morning' | 'Afternoon' | 'Evening' | 'Night';
  vehicle_type: 'Economy' | 'Premium';
  expected_ride_duration: number;
  historical_cost_of_ride: number;
}

interface SavedScenario {
  id: string;
  name: string;
  context: MarketContext;
  createdAt: string;
}

interface ContextState {
  context: MarketContext;
  savedScenarios: SavedScenario[];
  updateContext: (updates: Partial<MarketContext>) => void;
  resetContext: () => void;
  saveScenario: (name: string) => void;
  loadScenario: (id: string) => void;
  deleteScenario: (id: string) => void;
}

const defaultContext: MarketContext = {
  number_of_riders: 50,
  number_of_drivers: 25,
  location_category: 'Urban',
  customer_loyalty_status: 'Silver',
  number_of_past_rides: 10,
  average_ratings: 4.5,
  time_of_booking: 'Evening',
  vehicle_type: 'Premium',
  expected_ride_duration: 30,
  historical_cost_of_ride: 35.0,
};

export const useContextStore = create<ContextState>()(
  persist(
    (set, get) => ({
      context: defaultContext,
      savedScenarios: [],
      updateContext: (updates) => 
        set((s) => ({ context: { ...s.context, ...updates } })),
      resetContext: () => set({ context: defaultContext }),
      saveScenario: (name) => {
        const newScenario: SavedScenario = {
          id: crypto.randomUUID(),
          name,
          context: get().context,
          createdAt: new Date().toISOString(),
        };
        set((s) => ({ savedScenarios: [...s.savedScenarios, newScenario] }));
      },
      loadScenario: (id) => {
        const scenario = get().savedScenarios.find((s) => s.id === id);
        if (scenario) set({ context: scenario.context });
      },
      deleteScenario: (id) => 
        set((s) => ({ savedScenarios: s.savedScenarios.filter((sc) => sc.id !== id) })),
    }),
    { name: 'prismiq-context' }
  )
);
```

### Input Components (using shadcn/ui)
```tsx
// Example: LocationSection.tsx
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useContextStore } from '@/stores/contextStore';

export function LocationSection() {
  const { context, updateContext } = useContextStore();
  
  return (
    <div className="space-y-2">
      <label className="text-sm font-medium">Location</label>
      <Select 
        value={context.location_category}
        onValueChange={(v) => updateContext({ location_category: v as any })}
      >
        <SelectTrigger>
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="Urban">Urban</SelectItem>
          <SelectItem value="Suburban">Suburban</SelectItem>
          <SelectItem value="Rural">Rural</SelectItem>
        </SelectContent>
      </Select>
    </div>
  );
}
```

### Supply/Demand Ratio Display
```tsx
// Calculated ratio with visual indicator
const ratio = context.number_of_riders / context.number_of_drivers;
const ratioLabel = ratio > 2 ? 'High Demand' : ratio > 1 ? 'Balanced' : 'Low Demand';
const ratioColor = ratio > 2 ? 'text-red-500' : ratio > 1 ? 'text-yellow-500' : 'text-green-500';
```

### Testing

- Test file: `frontend/tests/unit/context/ContextPanel.test.tsx`
- Test context updates persist to localStorage
- Test scenario save/load/delete
- Test Apply Changes triggers correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

