# Story 4.3: Analyst Workspace - Center Panel (Chat)

## Status: Draft

## Assigned To: David

## Story

**As a** pricing analyst,
**I want** a conversational chat interface,
**so that** I can ask questions in natural language.

## Acceptance Criteria

1. Chat message area displays conversation history with scroll
2. Messages styled distinctly for user (right-aligned) vs AI (left-aligned)
3. AI responses render Markdown, include confidence badges, show timestamps
4. Chat input with send button and Enter key support
5. Loading state with animated typing indicator during API call
6. Auto-scroll to latest message on new response
7. Welcome message displayed on initial load

## Tasks / Subtasks

- [ ] Task 1: Create chat components directory (AC: 1)
  - [ ] Create `frontend/src/components/chat/` directory
  - [ ] Create `ChatPanel.tsx` main component
  - [ ] Plan component structure

- [ ] Task 2: Create message list component (AC: 1, 6)
  - [ ] Create `MessageList.tsx`
  - [ ] Render messages from store
  - [ ] Implement auto-scroll to bottom
  - [ ] Use virtualization if needed (for long chats)

- [ ] Task 3: Create message components (AC: 2, 3)
  - [ ] Create `Message.tsx` base component
  - [ ] Create `UserMessage.tsx` (right-aligned, user bubble)
  - [ ] Create `AIMessage.tsx` (left-aligned, AI bubble)
  - [ ] Style with distinct colors/shapes

- [ ] Task 4: Implement Markdown rendering (AC: 3)
  - [ ] Install react-markdown
  - [ ] Configure code highlighting
  - [ ] Style markdown elements

- [ ] Task 5: Create confidence badge (AC: 3)
  - [ ] Create `ConfidenceBadge.tsx`
  - [ ] Show percentage with color coding
  - [ ] Tooltip with explanation

- [ ] Task 6: Create timestamp display (AC: 3)
  - [ ] Format timestamps (e.g., "2:30 PM")
  - [ ] Show relative time for recent messages

- [ ] Task 7: Create chat input component (AC: 4)
  - [ ] Create `ChatInput.tsx`
  - [ ] Text input with send button
  - [ ] Enter key to send (Shift+Enter for newline)
  - [ ] Disable input while loading

- [ ] Task 8: Implement loading state (AC: 5)
  - [ ] Create `TypingIndicator.tsx`
  - [ ] Animated dots or shimmer
  - [ ] Show during API call

- [ ] Task 9: Create welcome message (AC: 7)
  - [ ] Show on initial load / empty chat
  - [ ] Include example questions
  - [ ] Clickable examples

- [ ] Task 10: Create chat store (AC: 1, 7)
  - [ ] Create `frontend/src/stores/chatStore.ts`
  - [ ] Store message history
  - [ ] Persist to localStorage

- [ ] Task 11: Integrate with API
  - [ ] Create `frontend/src/services/chatService.ts`
  - [ ] POST to `/api/v1/chat`
  - [ ] Handle streaming (optional)

## Dev Notes

### Component Structure
```
frontend/src/components/chat/
â”œâ”€â”€ ChatPanel.tsx           # Main container
â”œâ”€â”€ MessageList.tsx         # Scrollable message area
â”œâ”€â”€ Message.tsx             # Base message component
â”œâ”€â”€ UserMessage.tsx         # User message bubble
â”œâ”€â”€ AIMessage.tsx           # AI message with markdown
â”œâ”€â”€ ChatInput.tsx           # Input + send button
â”œâ”€â”€ TypingIndicator.tsx     # Loading animation
â”œâ”€â”€ ConfidenceBadge.tsx     # Confidence display
â””â”€â”€ WelcomeMessage.tsx      # Initial welcome
```

### Chat Store (Zustand)
```typescript
// stores/chatStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: string;
  confidence?: number;
  pricingResult?: any;  // Associated pricing result
}

interface ChatState {
  messages: Message[];
  isLoading: boolean;
  addMessage: (message: Omit<Message, 'id' | 'timestamp'>) => void;
  setLoading: (loading: boolean) => void;
  clearChat: () => void;
}

export const useChatStore = create<ChatState>()(
  persist(
    (set) => ({
      messages: [],
      isLoading: false,
      addMessage: (msg) => set((s) => ({
        messages: [...s.messages, {
          ...msg,
          id: crypto.randomUUID(),
          timestamp: new Date().toISOString(),
        }],
      })),
      setLoading: (isLoading) => set({ isLoading }),
      clearChat: () => set({ messages: [] }),
    }),
    { name: 'prismiq-chat' }
  )
);
```

### Message Styling
```tsx
// UserMessage.tsx
<div className="flex justify-end">
  <div className="max-w-[80%] bg-primary-500 text-white rounded-2xl rounded-tr-sm px-4 py-2">
    <p>{message.content}</p>
    <span className="text-xs opacity-70">{formatTime(message.timestamp)}</span>
  </div>
</div>

// AIMessage.tsx
<div className="flex justify-start">
  <div className="max-w-[80%] bg-gray-100 dark:bg-gray-800 rounded-2xl rounded-tl-sm px-4 py-2">
    <ReactMarkdown>{message.content}</ReactMarkdown>
    <div className="flex items-center gap-2 mt-2">
      {message.confidence && <ConfidenceBadge value={message.confidence} />}
      <span className="text-xs text-gray-500">{formatTime(message.timestamp)}</span>
    </div>
  </div>
</div>
```

### Typing Indicator
```tsx
// TypingIndicator.tsx
export function TypingIndicator() {
  return (
    <div className="flex items-center gap-1 p-2">
      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.3s]" />
      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce [animation-delay:-0.15s]" />
      <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" />
    </div>
  );
}
```

### Welcome Message Content
```tsx
const welcomeMessage = {
  greeting: "ðŸ‘‹ Welcome to PrismIQ!",
  description: "I'm your AI pricing copilot. Ask me anything about dynamic pricing.",
  examples: [
    "What's the optimal price for downtown rush hour?",
    "Why is surge pricing recommended?",
    "How sensitive is this to demand changes?",
    "Compare urban vs suburban pricing",
  ]
};
```

### Chat API Integration
```typescript
// services/chatService.ts
import ky from 'ky';

const api = ky.create({
  prefixUrl: process.env.NEXT_PUBLIC_API_URL,
});

export async function sendMessage(
  message: string, 
  context: MarketContext
): Promise<ChatResponse> {
  return api.post('api/v1/chat', {
    json: { message, context }
  }).json();
}
```

### Testing

- Test file: `frontend/tests/unit/chat/ChatPanel.test.tsx`
- Test message addition to store
- Test auto-scroll behavior
- Test loading state display

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

