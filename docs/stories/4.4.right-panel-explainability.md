# Story 4.4: Analyst Workspace - Right Panel (Explainability)

## Status: Draft

## Assigned To: David

## Story

**As a** pricing analyst,
**I want** explainability visualizations alongside chat,
**so that** I can understand recommendations in depth.

## Acceptance Criteria

1. **Recommendation Card:** Shows recommended price, confidence, profit uplift prominently
2. **Feature Importance:** Horizontal bar chart showing top factors (Recharts)
3. **Decision Trace:** Collapsible accordion showing pipeline steps
4. **Demand Curve:** Line chart showing price vs. demand relationship
5. **Profit Curve:** Line chart with area fill showing price vs. profit
6. **Sensitivity Analysis:** Expandable section with confidence bands
7. **Business Rules:** List of rules applied with impact indicators
8. Panel collapse functionality

## Tasks / Subtasks

- [ ] Task 1: Create visualizations directory (AC: 1-7)
  - [ ] Create `frontend/src/components/visualizations/` directory
  - [ ] Create `ExplainabilityPanel.tsx` main component

- [ ] Task 2: Create Recommendation Card (AC: 1)
  - [ ] Create `RecommendationCard.tsx`
  - [ ] Display recommended price (large, prominent)
  - [ ] Display confidence score with color coding
  - [ ] Display profit uplift percentage
  - [ ] Add loading skeleton state

- [ ] Task 3: Create Feature Importance Chart (AC: 2)
  - [ ] Create `FeatureImportanceChart.tsx`
  - [ ] Horizontal bar chart with Recharts
  - [ ] Sort by importance (descending)
  - [ ] Show percentage labels
  - [ ] Color code positive/negative impact

- [ ] Task 4: Create Decision Trace Accordion (AC: 3)
  - [ ] Create `DecisionTrace.tsx`
  - [ ] Collapsible accordion per step
  - [ ] Show timing, inputs, outputs
  - [ ] Visual step indicator (success/warning)

- [ ] Task 5: Create Demand Curve Chart (AC: 4)
  - [ ] Create `DemandCurveChart.tsx`
  - [ ] Line chart with Recharts
  - [ ] Mark optimal price point
  - [ ] Show current context point

- [ ] Task 6: Create Profit Curve Chart (AC: 5)
  - [ ] Create `ProfitCurveChart.tsx`
  - [ ] Area chart with gradient fill
  - [ ] Mark maximum profit point
  - [ ] Show baseline comparison

- [ ] Task 7: Create Sensitivity Section (AC: 6)
  - [ ] Create `SensitivitySection.tsx`
  - [ ] Expandable/collapsible
  - [ ] Show confidence band visualization
  - [ ] Display robustness score

- [ ] Task 8: Create Business Rules List (AC: 7)
  - [ ] Create `BusinessRulesList.tsx`
  - [ ] List each rule applied
  - [ ] Show impact (before → after)
  - [ ] Color code by rule type

- [ ] Task 9: Create pricing result store
  - [ ] Create `frontend/src/stores/pricingStore.ts`
  - [ ] Store current pricing result
  - [ ] Store explanation data

- [ ] Task 10: Integrate with layout (AC: 8)
  - [ ] Import into RightPanel
  - [ ] Ensure collapse functionality works
  - [ ] Responsive layout

## Dev Notes

### Component Structure
```
frontend/src/components/visualizations/
├── ExplainabilityPanel.tsx      # Main container
├── RecommendationCard.tsx       # Price/confidence display
├── FeatureImportanceChart.tsx   # Horizontal bar chart
├── DecisionTrace.tsx            # Accordion with steps
├── DemandCurveChart.tsx         # Price vs demand line
├── ProfitCurveChart.tsx         # Price vs profit area
├── SensitivitySection.tsx       # Confidence bands
└── BusinessRulesList.tsx        # Rules with impacts
```

### Pricing Store (Zustand)
```typescript
// stores/pricingStore.ts
import { create } from 'zustand';

interface PricingState {
  result: PricingResult | null;
  explanation: PriceExplanation | null;
  sensitivity: SensitivityResult | null;
  isLoading: boolean;
  setResult: (result: PricingResult) => void;
  setExplanation: (explanation: PriceExplanation) => void;
  setSensitivity: (sensitivity: SensitivityResult) => void;
  setLoading: (loading: boolean) => void;
  clear: () => void;
}

export const usePricingStore = create<PricingState>((set) => ({
  result: null,
  explanation: null,
  sensitivity: null,
  isLoading: false,
  setResult: (result) => set({ result }),
  setExplanation: (explanation) => set({ explanation }),
  setSensitivity: (sensitivity) => set({ sensitivity }),
  setLoading: (isLoading) => set({ isLoading }),
  clear: () => set({ result: null, explanation: null, sensitivity: null }),
}));
```

### Recommendation Card
```tsx
// RecommendationCard.tsx
export function RecommendationCard({ result }: { result: PricingResult }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>Recommended Price</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="text-4xl font-bold text-primary">
          ${result.recommended_price.toFixed(2)}
        </div>
        <div className="flex gap-4 mt-4">
          <div>
            <span className="text-sm text-muted-foreground">Confidence</span>
            <ConfidenceBadge value={result.confidence_score} />
          </div>
          <div>
            <span className="text-sm text-muted-foreground">Profit Uplift</span>
            <span className={cn(
              "text-lg font-semibold",
              result.profit_uplift_percent > 0 ? "text-green-500" : "text-red-500"
            )}>
              {result.profit_uplift_percent > 0 ? '+' : ''}{result.profit_uplift_percent.toFixed(1)}%
            </span>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

### Feature Importance Chart (Recharts)
```tsx
// FeatureImportanceChart.tsx
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';

export function FeatureImportanceChart({ data }: { data: FeatureContribution[] }) {
  const chartData = data.slice(0, 6).map(d => ({
    name: d.display_name,
    value: d.importance * 100,
    fill: d.direction === 'positive' ? '#10b981' : '#ef4444',
  }));

  return (
    <ResponsiveContainer width="100%" height={200}>
      <BarChart data={chartData} layout="vertical">
        <XAxis type="number" domain={[0, 100]} tickFormatter={(v) => `${v}%`} />
        <YAxis type="category" dataKey="name" width={100} />
        <Tooltip formatter={(v: number) => `${v.toFixed(1)}%`} />
        <Bar dataKey="value" />
      </BarChart>
    </ResponsiveContainer>
  );
}
```

### Profit Curve Chart
```tsx
// ProfitCurveChart.tsx
import { AreaChart, Area, XAxis, YAxis, Tooltip, ReferenceDot, ResponsiveContainer } from 'recharts';

export function ProfitCurveChart({ data, optimalPrice }: Props) {
  const optimalPoint = data.find(d => Math.abs(d.price - optimalPrice) < 0.5);
  
  return (
    <ResponsiveContainer width="100%" height={200}>
      <AreaChart data={data}>
        <XAxis dataKey="price" tickFormatter={(v) => `$${v}`} />
        <YAxis tickFormatter={(v) => `$${v}`} />
        <Tooltip />
        <Area 
          type="monotone" 
          dataKey="profit" 
          stroke="#3b82f6" 
          fill="url(#profitGradient)" 
        />
        {optimalPoint && (
          <ReferenceDot 
            x={optimalPoint.price} 
            y={optimalPoint.profit}
            r={6}
            fill="#10b981"
            stroke="#fff"
          />
        )}
        <defs>
          <linearGradient id="profitGradient" x1="0" y1="0" x2="0" y2="1">
            <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3}/>
            <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
          </linearGradient>
        </defs>
      </AreaChart>
    </ResponsiveContainer>
  );
}
```

### Testing

- Test file: `frontend/tests/unit/visualizations/ExplainabilityPanel.test.tsx`
- Test charts render with mock data
- Test loading states
- Test panel collapse

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

