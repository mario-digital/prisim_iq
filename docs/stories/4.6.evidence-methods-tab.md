# Story 4.6: Evidence & Methods Tab

## Status: Ready for Review
## Assigned To: David

## Story

**As an** auditor,
**I want** access to methodology documentation,
**so that** I can verify the system's reliability.

## Acceptance Criteria

1. Left panel: Documentation navigation tree (Model Cards, Data Card, Methodology, Audit Trail, Downloads)
2. Center panel: Documentation Viewer rendering selected document (Markdown → HTML)
3. Right panel: Quick reference cards for models and data, Quick Actions
4. "Questions? Open Chat" button navigates to Analyst Workspace with context
5. "Email to Executives" button (mock or mailto link)
6. "Download All" button exports documentation as ZIP

## Tasks / Subtasks

- [x] Task 1: Create evidence page structure (AC: 1, 2, 3)
  - [x] Create `frontend/src/app/evidence/page.tsx`
  - [x] Set up three-panel content for evidence view

- [x] Task 2: Create Documentation Navigation (AC: 1)
  - [x] Create `frontend/src/components/evidence/DocNavigation.tsx`
  - [x] Tree structure with categories
  - [x] Highlight selected document
  - [x] Expandable/collapsible sections

- [x] Task 3: Create Documentation Viewer (AC: 2)
  - [x] Create `frontend/src/components/evidence/DocViewer.tsx`
  - [x] Fetch content from `/api/v1/evidence`
  - [x] Render Markdown using react-markdown
  - [x] Style for readability

- [x] Task 4: Create Quick Reference Panel (AC: 3)
  - [x] Create `frontend/src/components/evidence/QuickReference.tsx`
  - [x] Model summary cards (3 models)
  - [x] Data summary card
  - [x] Compact display format

- [x] Task 5: Create navigation links (AC: 4)
  - [x] "Questions? Open Chat" button
  - [x] Navigate to /workspace with context
  - [x] Pass selected doc topic as chat prompt

- [x] Task 6: Create action buttons (AC: 5, 6)
  - [x] "Email to Executives" button (mailto link)
  - [x] "Download All" button
  - [x] Mock or implement ZIP export

- [x] Task 7: Create evidence service
  - [x] Create `frontend/src/services/evidenceService.ts`
  - [x] Fetch evidence from API
  - [x] Cache responses

- [x] Task 8: Integrate with API
  - [x] Fetch from `GET /api/v1/evidence`
  - [x] Fetch from `GET /api/v1/honeywell_mapping`
  - [x] Handle loading and error states

## Dev Notes

### Component Structure
```
frontend/src/components/evidence/
├── EvidencePage.tsx         # Page layout
├── DocNavigation.tsx        # Left panel tree
├── DocViewer.tsx           # Center panel viewer
├── QuickReference.tsx      # Right panel cards
├── ModelCard.tsx           # Model summary card
├── DataCard.tsx            # Data summary card
└── EvidenceActions.tsx     # Action buttons
```

### Documentation Tree Structure
```typescript
const docTree = [
  {
    category: "Model Documentation",
    items: [
      { id: "xgboost", label: "XGBoost Model Card" },
      { id: "decision_tree", label: "Decision Tree Model Card" },
      { id: "linear_regression", label: "Linear Regression Model Card" },
    ]
  },
  {
    category: "Data Documentation",
    items: [
      { id: "data_card", label: "Dataset Card" },
      { id: "feature_definitions", label: "Feature Definitions" },
    ]
  },
  {
    category: "Methodology",
    items: [
      { id: "pricing_algorithm", label: "Pricing Algorithm" },
      { id: "demand_modeling", label: "Demand Modeling" },
      { id: "rules_engine", label: "Business Rules" },
    ]
  },
  {
    category: "Compliance",
    items: [
      { id: "audit_trail", label: "Audit Trail" },
      { id: "honeywell_mapping", label: "Honeywell Mapping" },
    ]
  },
];
```

### DocNavigation Component
```tsx
// DocNavigation.tsx
export function DocNavigation({ 
  selectedId, 
  onSelect 
}: { 
  selectedId: string; 
  onSelect: (id: string) => void;
}) {
  return (
    <nav className="space-y-4">
      {docTree.map((category) => (
        <div key={category.category}>
          <h3 className="font-semibold text-sm mb-2">{category.category}</h3>
          <ul className="space-y-1">
            {category.items.map((item) => (
              <li key={item.id}>
                <button
                  onClick={() => onSelect(item.id)}
                  className={cn(
                    "w-full text-left px-3 py-2 rounded text-sm",
                    selectedId === item.id 
                      ? "bg-primary-100 text-primary-700" 
                      : "hover:bg-gray-100"
                  )}
                >
                  {item.label}
                </button>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </nav>
  );
}
```

### DocViewer Component
```tsx
// DocViewer.tsx
import ReactMarkdown from 'react-markdown';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';

export function DocViewer({ content, isLoading }: { content: string; isLoading: boolean }) {
  if (isLoading) {
    return <DocumentSkeleton />;
  }

  return (
    <article className="prose prose-slate dark:prose-invert max-w-none">
      <ReactMarkdown
        components={{
          code({ node, inline, className, children, ...props }) {
            const match = /language-(\w+)/.exec(className || '');
            return !inline && match ? (
              <SyntaxHighlighter language={match[1]} {...props}>
                {String(children).replace(/\n$/, '')}
              </SyntaxHighlighter>
            ) : (
              <code className={className} {...props}>{children}</code>
            );
          },
        }}
      >
        {content}
      </ReactMarkdown>
    </article>
  );
}
```

### Quick Reference Cards
```tsx
// QuickReference.tsx
export function QuickReference({ evidence }: { evidence: EvidenceResponse }) {
  return (
    <div className="space-y-4">
      <h3 className="font-semibold">Quick Reference</h3>
      
      {/* Model Summary Cards */}
      {evidence.model_cards.map((card) => (
        <ModelSummaryCard key={card.model_name} card={card} />
      ))}
      
      {/* Data Summary Card */}
      <DataSummaryCard card={evidence.data_card} />
      
      {/* Quick Actions */}
      <div className="pt-4 border-t space-y-2">
        <Button variant="outline" className="w-full" asChild>
          <Link href="/workspace">
            Questions? Open Chat →
          </Link>
        </Button>
        <Button variant="outline" className="w-full">
          Email to Executives
        </Button>
        <Button variant="outline" className="w-full">
          Download All (ZIP)
        </Button>
      </div>
    </div>
  );
}
```

### Evidence Service
```typescript
// services/evidenceService.ts
import ky from 'ky';

const api = ky.create({
  prefixUrl: process.env.NEXT_PUBLIC_API_URL,
});

let cachedEvidence: EvidenceResponse | null = null;

export async function getEvidence(): Promise<EvidenceResponse> {
  if (cachedEvidence) return cachedEvidence;
  
  cachedEvidence = await api.get('api/v1/evidence').json();
  return cachedEvidence;
}

export async function getHoneywellMapping(): Promise<HoneywellMappingResponse> {
  return api.get('api/v1/honeywell_mapping').json();
}
```

### Testing

- Test file: `frontend/tests/unit/evidence/DocViewer.test.tsx`
- Test Markdown rendering
- Test navigation tree selection
- Test action buttons

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |
| 2025-12-03 | 1.1 | Implementation complete - all tasks done | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (via Cursor)

### Debug Log References
- `bun run build` - Build successful, evidence page compiles at 7.89 kB
- `bun test tests/unit/evidence` - 21 tests pass
- `bun test` - Full suite: 63 tests pass, 0 fail

### Completion Notes List
1. Created three-panel evidence page using MasterLayout pattern
2. DocNavigation: Expandable/collapsible tree with 4 categories, visual selection state, aria-labels
3. DocViewer: ReactMarkdown renderer with custom code block, table, and blockquote styling
4. QuickReference: Model summary cards showing R², RMSE, architecture; Data summary with stats
5. EvidenceActions: Chat link with topic context, mailto for executives, mock ZIP download
6. evidenceService: ky-based API client with caching and comprehensive fallback content for offline/demo use
7. Types defined in types.ts: ModelCard, DataCard, EvidenceResponse, HoneywellMappingResponse
8. Note: Backend evidence API endpoint not yet implemented - service includes fallback data

### File List
**New Files:**
- `frontend/src/components/evidence/index.ts`
- `frontend/src/components/evidence/types.ts`
- `frontend/src/components/evidence/DocNavigation.tsx`
- `frontend/src/components/evidence/DocViewer.tsx`
- `frontend/src/components/evidence/QuickReference.tsx`
- `frontend/src/components/evidence/ModelSummaryCard.tsx`
- `frontend/src/components/evidence/DataSummaryCard.tsx`
- `frontend/src/components/evidence/EvidenceActions.tsx`
- `frontend/src/services/evidenceService.ts`
- `frontend/tests/unit/evidence/DocViewer.test.tsx`
- `frontend/tests/unit/evidence/DocNavigation.test.tsx`
- `frontend/tests/unit/evidence/EvidenceActions.test.tsx`

**Modified Files:**
- `frontend/src/app/evidence/page.tsx`

## QA Results

### Review Date: 2025-12-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: GOOD** - Clean implementation that follows project patterns and conventions.

**Strengths Identified:**
- Clean component architecture with proper separation of concerns (DocNavigation, DocViewer, QuickReference, EvidenceActions)
- Comprehensive TypeScript typing with dedicated `types.ts` file defining all interfaces
- Barrel exports in `index.ts` for clean import patterns
- Accessibility features present: `aria-labels`, `aria-expanded`, `aria-current` attributes
- Loading skeletons implemented for all async states
- Robust fallback content in `evidenceService.ts` enables offline/demo mode
- External links properly secured with `target="_blank"` + `rel="noopener noreferrer"`
- Error handling with user-friendly error messages in evidence page

**Minor Observations:**
- The `docTree` data structure is duplicated between `DocNavigation.tsx` and tests - could be centralized for maintainability
- Tests are logic/type-focused (appropriate for Bun test without JSDOM)

### Refactoring Performed

No refactoring required - implementation is clean and well-structured.

### Compliance Check

- Coding Standards: ✅ Components follow PascalCase naming, proper TypeScript imports, FC types used correctly
- Project Structure: ✅ Components in `components/evidence/`, service in `services/`, tests in `tests/unit/evidence/`
- Testing Strategy: ✅ Unit tests present covering navigation structure, action logic, and type validation (21 tests)
- All ACs Met: ✅ All 6 acceptance criteria fully implemented

### Improvements Checklist

- [x] Three-panel layout using MasterLayout pattern
- [x] Expandable/collapsible navigation tree with aria attributes
- [x] Markdown rendering with custom component styling
- [x] Model and data summary cards with metrics display
- [x] Chat navigation with topic context passing
- [x] Email mailto link with pre-filled subject/body
- [x] Download button with mock implementation (as spec'd)
- [x] Service caching for performance
- [x] Comprehensive fallback data for API unavailability
- [ ] Consider centralizing `docTree` structure to avoid duplication with tests
- [ ] Consider adding integration tests when backend evidence API is ready

### Security Review

✅ **No security concerns identified.**
- External links properly secured with `target="_blank"` + `rel="noopener noreferrer"`
- No sensitive data handling
- Service uses standard API patterns

### Performance Considerations

✅ **Good performance design.**
- Service-level caching implemented for evidence data
- Skeleton loaders reduce perceived latency
- Fallback content prevents blocking on API failures

### Files Modified During Review

No files modified - implementation meets quality standards.

### Gate Status

Gate: **PASS** → `docs/qa/gates/4.6-evidence-methods-tab.yml`

### Recommended Status

✅ **Ready for Done**
(All acceptance criteria met, tests passing, code quality good)

