# Story 4.8: Honeywell Mapping Overlay

## Status: Done

## Assigned To: Gabriel

## Story

**As a** hackathon judge,
**I want** to see the ride-sharing to Honeywell mapping,
**so that** I understand the business applicability.

## Acceptance Criteria

1. üí° toggle button in header opens modal overlay
2. Overlay displays mapping table: Ride-Sharing Concept ‚Üí Honeywell Equivalent ‚Üí Rationale
3. Close button (X) and Escape key dismiss the overlay
4. "Download PDF" button exports mapping document
5. Overlay accessible from any tab (persists across navigation)
6. Modal has proper accessibility (focus trap, aria labels)

## Tasks / Subtasks

- [x] Task 1: Create modal component (AC: 1, 3, 6)
  - [x] Create `frontend/src/components/honeywell/HoneywellOverlay.tsx`
  - [x] Use shadcn/ui Dialog component
  - [x] Implement close on X button
  - [x] Implement close on Escape key
  - [x] Add focus trap for accessibility
  - [x] Add aria labels

- [x] Task 2: Create overlay content (AC: 2)
  - [x] Create mapping table display
  - [x] Three columns: Ride-Sharing, Honeywell, Rationale
  - [x] Style for readability
  - [x] Add section header/description

- [x] Task 3: Create toggle state (AC: 1, 5)
  - [x] Add `isHoneywellOpen` to layout store (already exists in statusStore as `honeywellOverlayVisible`)
  - [x] Create toggle function (already exists as `toggleHoneywellOverlay`)
  - [x] Persist across tab navigation

- [x] Task 4: Create Download PDF button (AC: 4)
  - [x] Add "Download PDF" button
  - [x] Mock implementation (exports as formatted text file)
  - [x] Style as secondary action

- [x] Task 5: Fetch mapping data (AC: 2)
  - [x] Call `/api/v1/honeywell_mapping` endpoint
  - [x] Cache response
  - [x] Handle loading state

- [x] Task 6: Style overlay (AC: 2)
  - [x] Clean, professional appearance
  - [x] Good contrast for readability
  - [x] Responsive for different screen sizes

## Dev Notes

### Component Structure
```
frontend/src/components/honeywell/
‚îú‚îÄ‚îÄ HoneywellOverlay.tsx    # Modal container
‚îú‚îÄ‚îÄ MappingTable.tsx        # Table display
‚îî‚îÄ‚îÄ MappingRow.tsx          # Individual row
```

### HoneywellOverlay Component
```tsx
// HoneywellOverlay.tsx
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog';
import { useLayoutStore } from '@/stores/layoutStore';
import { MappingTable } from './MappingTable';

export function HoneywellOverlay() {
  const { isHoneywellOpen, setHoneywellOpen } = useLayoutStore();
  
  return (
    <Dialog open={isHoneywellOpen} onOpenChange={setHoneywellOpen}>
      <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>üè≠ Ride-Sharing to Honeywell Mapping</DialogTitle>
          <DialogDescription>
            How dynamic pricing concepts translate to enterprise applications
          </DialogDescription>
        </DialogHeader>
        
        <MappingTable />
        
        <div className="flex justify-end gap-2 mt-4">
          <Button variant="outline" onClick={handleDownloadPDF}>
            Download PDF
          </Button>
          <Button onClick={() => setHoneywellOpen(false)}>
            Close
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

### MappingTable Component
```tsx
// MappingTable.tsx
import { useEffect, useState } from 'react';
import { getHoneywellMapping } from '@/services/evidenceService';

export function MappingTable() {
  const [mapping, setMapping] = useState<HoneywellMappingResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  
  useEffect(() => {
    getHoneywellMapping()
      .then(setMapping)
      .finally(() => setIsLoading(false));
  }, []);
  
  if (isLoading) {
    return <TableSkeleton />;
  }
  
  return (
    <div className="border rounded-lg overflow-hidden">
      <table className="w-full">
        <thead className="bg-muted">
          <tr>
            <th className="px-4 py-3 text-left font-medium">Ride-Sharing Concept</th>
            <th className="px-4 py-3 text-left font-medium">Honeywell Equivalent</th>
            <th className="px-4 py-3 text-left font-medium">Rationale</th>
          </tr>
        </thead>
        <tbody className="divide-y">
          {mapping?.mappings.map((row, i) => (
            <tr key={i} className="hover:bg-muted/50">
              <td className="px-4 py-3 font-medium">{row.ride_sharing_concept}</td>
              <td className="px-4 py-3">{row.honeywell_equivalent}</td>
              <td className="px-4 py-3 text-sm text-muted-foreground">
                {row.rationale}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

### Layout Store Update
```typescript
// Add to stores/layoutStore.ts
interface LayoutState {
  // ... existing fields
  isHoneywellOpen: boolean;
  setHoneywellOpen: (open: boolean) => void;
}

// In the store:
isHoneywellOpen: false,
setHoneywellOpen: (isHoneywellOpen) => set({ isHoneywellOpen }),
```

### Mapping Data (Static Fallback)
```typescript
const fallbackMapping = {
  title: "Ride-Sharing to Honeywell Enterprise Mapping",
  mappings: [
    {
      ride_sharing_concept: "Number of Riders (Demand)",
      honeywell_equivalent: "Product Demand Forecast",
      rationale: "Both represent customer demand signals that drive pricing decisions"
    },
    {
      ride_sharing_concept: "Number of Drivers (Supply)",
      honeywell_equivalent: "Inventory/Capacity Levels",
      rationale: "Available supply constrains pricing flexibility"
    },
    {
      ride_sharing_concept: "Surge Pricing",
      honeywell_equivalent: "Dynamic Pricing / Premium Pricing",
      rationale: "Price adjustment based on supply-demand imbalance"
    },
    {
      ride_sharing_concept: "Customer Loyalty Tier",
      honeywell_equivalent: "Customer Segmentation",
      rationale: "Different segments have different price sensitivity"
    },
    {
      ride_sharing_concept: "Location Category",
      honeywell_equivalent: "Market/Region Segmentation",
      rationale: "Geographic factors affect pricing"
    },
    {
      ride_sharing_concept: "Vehicle Type",
      honeywell_equivalent: "Product Tier / SKU",
      rationale: "Different product tiers command different prices"
    },
  ]
};
```

### Accessibility Requirements
- Focus trap within modal (Dialog handles this)
- `aria-labelledby` pointing to title
- `aria-describedby` pointing to description
- Close on Escape key (Dialog handles this)
- Return focus to trigger button on close

### Download PDF (Mock Implementation)
```typescript
function handleDownloadPDF() {
  // For hackathon: simple mock
  const content = mapping?.mappings.map(m => 
    `${m.ride_sharing_concept} ‚Üí ${m.honeywell_equivalent}\n${m.rationale}\n`
  ).join('\n---\n');
  
  const blob = new Blob([content || ''], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'honeywell-mapping.txt';
  a.click();
}
```

### Testing

- Test file: `frontend/tests/unit/honeywell/HoneywellOverlay.test.tsx`
- Test modal opens on toggle
- Test modal closes on X, Escape, and overlay click
- Test table renders mapping data
- Test download button triggers download

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | Initial story creation | SM Agent |
| 2024-12-04 | 1.1 | Implementation complete: Dialog, HoneywellOverlay, MappingTable, tests | Dev Agent (James) |
| 2024-12-04 | 1.2 | QA Review: PASS gate, added error state improvement | QA Agent (Quinn) |
| 2024-12-04 | 1.3 | Status: Done | Gabriel |

## Dev Agent Record

### Agent Model Used
Claude Opus 4 (via Cursor)

### Debug Log References
- `bun test` - All 11 Honeywell-specific tests passing
- `bun run lint` - No lint errors (deprecation warning only)

### Completion Notes List
1. Created Dialog UI component (`frontend/src/components/ui/dialog.tsx`) using shadcn/ui pattern with Radix primitives
2. Created `HoneywellOverlay.tsx` - Modal component with Dialog, accessibility features (focus trap, aria labels built into Radix Dialog)
3. Created `MappingTable.tsx` - Table display with loading skeleton, 3-column layout
4. Updated `HoneywellMappingResponse` type to include `mappings[]` array with `ride_sharing_concept`, `honeywell_equivalent`, `rationale` fields
5. Updated `evidenceService.ts` with comprehensive fallback mapping data (8 mapping entries)
6. Integrated `HoneywellOverlay` into `MasterLayout.tsx` - accessible from any tab
7. Leveraged existing `statusStore` which already had `honeywellOverlayVisible` and toggle functions
8. Existing `HoneywellToggle` component in header already wired up correctly
9. Download exports as formatted text file (hackathon-appropriate mock)
10. Added `@radix-ui/react-dialog` dependency to package.json (requires `bun install`)

### File List
**Created:**
- `frontend/src/components/ui/dialog.tsx`
- `frontend/src/components/honeywell/HoneywellOverlay.tsx`
- `frontend/src/components/honeywell/MappingTable.tsx`
- `frontend/src/components/honeywell/index.ts`
- `frontend/tests/unit/honeywell/HoneywellOverlay.test.tsx`

**Modified:**
- `frontend/package.json` (added @radix-ui/react-dialog dependency)
- `frontend/src/components/evidence/types.ts` (added HoneywellMappingItem type, updated HoneywellMappingResponse)
- `frontend/src/services/evidenceService.ts` (updated fallback mapping data structure)
- `frontend/src/components/layout/MasterLayout.tsx` (integrated HoneywellOverlay)

## QA Results

### Review Date: 2024-12-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Good** - Clean implementation following established patterns with proper TypeScript typing, React best practices, and good component structure. The code is maintainable and well-documented.

**Strengths:**
- Proper use of `useCallback` for download handler optimization
- Memory cleanup in download function (`revokeObjectURL`, element removal)
- Good loading skeleton UX with `TableSkeleton` component
- Empty state handling in `MappingTable`
- Comprehensive fallback mapping data (8 entries)
- Excellent caching implementation in `evidenceService.ts`
- Good JSDoc documentation throughout

### Refactoring Performed

None required - code quality is good for hackathon scope.

### Compliance Check

- Coding Standards: ‚úì Follows project patterns
- Project Structure: ‚úì Components properly organized in `honeywell/` folder
- Testing Strategy: ‚úì Unit tests present, 11 tests passing
- All ACs Met: ‚úì All 6 acceptance criteria have functional implementation

### Improvements Checklist

- [x] Add error state to `MappingTable.tsx` to distinguish API failure from empty data ‚úÖ **Implemented 2024-12-04**
- [ ] Consider adding DOM integration test with React Testing Library for modal open/close behavior
- [ ] Post-hackathon: Consider actual PDF export or update button label to match .txt output

### Security Review

No concerns - component displays read-only data, no user input, no authentication required.

### Performance Considerations

‚úì Caching implemented for API responses
‚úì Lazy loading of mapping data (only fetches when overlay opens)
‚úì Loading skeleton provides good perceived performance

### Files Modified During Review

- `frontend/src/components/honeywell/MappingTable.tsx` - Added error state with retry capability (per user request)

### Gate Status

Gate: PASS ‚Üí docs/qa/gates/4.8-honeywell-overlay.yml

### Recommended Status

‚úì Ready for Done - All acceptance criteria met, tests passing, code quality good for hackathon scope. Minor improvements noted are non-blocking.

