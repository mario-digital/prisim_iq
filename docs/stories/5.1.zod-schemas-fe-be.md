# Story 5.1: Create Zod Schemas for Frontend-Backend Type Safety

## Status: Draft

## Story

**As a** frontend developer,
**I want** runtime validation of all API responses using Zod schemas that mirror backend Pydantic models,
**so that** we have a single source of truth for types, early detection of API contract drift, and type-safe data handling throughout the frontend.

## Acceptance Criteria

1. Zod installed in `packages/shared` and new `schemas/` directory structure created
2. All ~35 backend Pydantic schemas converted to equivalent Zod schemas with matching validation rules
3. TypeScript types inferred from Zod schemas (single source of truth)
4. Validated API client utility created that validates all responses at runtime
5. Existing services migrated to use validated client
6. All duplicate type definitions removed from frontend
7. Unit tests for schemas with >80% coverage
8. No breaking changes to existing component interfaces

## Tasks / Subtasks

- [ ] Task 1: Foundation & Setup (AC: 1)
  - [ ] Install Zod in `packages/shared`: `bun add zod`
  - [ ] Create `packages/shared/src/schemas/` directory
  - [ ] Create `schemas/index.ts` for central exports
  - [ ] Update `packages/shared/package.json` with schemas export path

- [ ] Task 2: Core Schemas - Priority 1 (AC: 2, 3)
  - [ ] Create `schemas/common.ts` with `ErrorResponseSchema`
  - [ ] Create `schemas/market.ts` with `MarketContextSchema` and all enum schemas
  - [ ] Create `schemas/segment.ts` with `SegmentResultSchema`, `SegmentDetailsSchema`
  - [ ] Create `schemas/rules.ts` with `AppliedRuleSchema`, `RulesResultSchema`
  - [ ] Create `schemas/optimization.ts` with `PriceDemandPointSchema`, `OptimizationResultSchema`
  - [ ] Create `schemas/pricing.ts` with `PricingResultSchema`
  - [ ] Create `schemas/chat.ts` with `ChatRequestSchema`, `ChatResponseSchema`, `ChatStreamEventSchema`

- [ ] Task 3: Explainability Schemas - Priority 2 (AC: 2, 3)
  - [ ] Create `schemas/explainability.ts` with `FeatureContributionSchema`, `FeatureImportanceResultSchema`
  - [ ] Create `schemas/decision-trace.ts` with `TraceStepSchema`, `ModelAgreementSchema`, `DecisionTraceSchema`
  - [ ] Create `schemas/explanation.ts` with `ExplainRequestSchema`, `PriceExplanationSchema`

- [ ] Task 4: Evidence Schemas - Priority 3 (AC: 2, 3)
  - [ ] Create `schemas/evidence.ts` with all ModelCard-related schemas
  - [ ] Add all DataCard-related schemas
  - [ ] Add `MethodologyDocSchema`, `DocSectionSchema` (recursive)
  - [ ] Add `EvidenceResponseSchema`
  - [ ] Add `HoneywellMappingSchema`, `HoneywellMappingResponseSchema`

- [ ] Task 5: Remaining Schemas - Priority 4-5 (AC: 2, 3)
  - [ ] Create `schemas/sensitivity.ts` with all sensitivity-related schemas
  - [ ] Create `schemas/health.ts` with `HealthResponseSchema`
  - [ ] Create `schemas/data.ts` with `PriceRangeSchema`, `DataSummaryResponseSchema`

- [ ] Task 6: Validated API Client (AC: 4)
  - [ ] Create `frontend/src/lib/api-client.ts`
  - [ ] Implement `fetchValidated<T>()` generic function
  - [ ] Implement `postValidated<T, B>()` generic function
  - [ ] Create `ValidationError` class with Zod error details
  - [ ] Add proper error logging for validation failures

- [ ] Task 7: Migrate Services (AC: 5)
  - [ ] Update `frontend/src/services/chatService.ts` to use validated client
  - [ ] Update evidence service to use validated client
  - [ ] Update `frontend/src/stores/contextStore.ts` to use schema types
  - [ ] Update `frontend/src/stores/pricingStore.ts` to use schema types

- [ ] Task 8: Cleanup & Consolidation (AC: 6, 8)
  - [ ] Update `packages/shared/src/types/index.ts` to re-export from schemas
  - [ ] Remove duplicate types from `frontend/src/components/evidence/types.ts`
  - [ ] Remove duplicate types from `frontend/src/components/visualizations/types.ts`
  - [ ] Remove inline types from service files
  - [ ] Update component imports to use schema types
  - [ ] Verify no breaking changes to components

- [ ] Task 9: Unit Tests (AC: 7)
  - [ ] Create `packages/shared/src/schemas/__tests__/` directory
  - [ ] Add tests for `market.test.ts` - validation and rejection cases
  - [ ] Add tests for `pricing.test.ts`
  - [ ] Add tests for `chat.test.ts`
  - [ ] Add tests for complex nested schemas (evidence, explanation)
  - [ ] Verify >80% coverage on schema files

## Dev Notes

### Source Document
This story is based on `docs/zod-frontend-validation-plan.md` created by the Architect Agent.

### Pydantic → Zod Mapping Rules

| Pydantic | Zod Equivalent |
|----------|----------------|
| `str` | `z.string()` |
| `int` | `z.number().int()` |
| `float` | `z.number()` |
| `bool` | `z.boolean()` |
| `datetime` | `z.string().datetime()` or `z.coerce.date()` |
| `list[T]` | `z.array(TSchema)` |
| `dict[str, T]` | `z.record(z.string(), TSchema)` |
| `T \| None` | `TSchema.nullable()` |
| `Field(default=X)` | `.default(X)` |
| `Field(ge=X, le=Y)` | `.min(X).max(Y)` |
| `Field(min_length=X)` | `.min(X)` |
| `Literal["a", "b"]` | `z.enum(["a", "b"])` |
| `BaseModel` (nested) | Compose schemas |

### MarketContext Reference (Backend Source)

```python
# backend/src/schemas/market.py
class MarketContext(BaseModel):
    number_of_riders: int = Field(..., ge=1, le=100)
    number_of_drivers: int = Field(..., ge=1, le=100)
    location_category: Literal["Urban", "Suburban", "Rural"]
    customer_loyalty_status: Literal["Bronze", "Silver", "Gold", "Platinum"]
    number_of_past_rides: int = Field(..., ge=0)
    average_ratings: float = Field(..., ge=1.0, le=5.0)
    time_of_booking: Literal["Morning", "Afternoon", "Evening", "Night"]
    vehicle_type: Literal["Economy", "Premium"]
    expected_ride_duration: int = Field(..., ge=1)
    historical_cost_of_ride: float = Field(..., ge=0)
    tier_prices: dict[str, float] | None = Field(default=None)
    
    # @computed_field - supply_demand_ratio (client-side function, not schema)
```

### Target Zod Schema Example

```typescript
// packages/shared/src/schemas/market.ts
import { z } from 'zod';

export const LocationCategory = z.enum(['Urban', 'Suburban', 'Rural']);
export const CustomerLoyaltyStatus = z.enum(['Bronze', 'Silver', 'Gold', 'Platinum']);
export const TimeOfBooking = z.enum(['Morning', 'Afternoon', 'Evening', 'Night']);
export const VehicleType = z.enum(['Economy', 'Premium']);

export const MarketContextSchema = z.object({
  number_of_riders: z.number().int().min(1).max(100),
  number_of_drivers: z.number().int().min(1).max(100),
  location_category: LocationCategory,
  customer_loyalty_status: CustomerLoyaltyStatus,
  number_of_past_rides: z.number().int().min(0),
  average_ratings: z.number().min(1.0).max(5.0),
  time_of_booking: TimeOfBooking,
  vehicle_type: VehicleType,
  expected_ride_duration: z.number().int().min(1),
  historical_cost_of_ride: z.number().min(0),
  tier_prices: z.record(z.string(), z.number()).nullable().optional(),
});

export type MarketContext = z.infer<typeof MarketContextSchema>;

// Computed field as helper function
export function getSupplyDemandRatio(context: MarketContext): number {
  return context.number_of_drivers / context.number_of_riders;
}
```

### Validated API Client Pattern

```typescript
// frontend/src/lib/api-client.ts
import ky from 'ky';
import { z } from 'zod';

export async function fetchValidated<T>(
  endpoint: string,
  schema: z.ZodType<T>,
  options?: Parameters<typeof api.get>[1]
): Promise<T> {
  const response = await api.get(endpoint, options).json();
  const result = schema.safeParse(response);
  
  if (!result.success) {
    console.error('API Response Validation Failed:', result.error.issues);
    throw new ValidationError(endpoint, result.error);
  }
  
  return result.data;
}
```

### Backend Schema Files to Reference

All source schemas are in `backend/src/schemas/`:
- `market.py` - MarketContext
- `chat.py` - ChatRequest, ChatResponse, ChatStreamEvent
- `data.py` - PriceRange, DataSummaryResponse, ErrorResponse
- `evidence.py` - ModelCard, DataCard, MethodologyDoc, EvidenceResponse, HoneywellMapping
- `explainability.py` - FeatureContribution, FeatureImportanceResult
- `explanation.py` - ExplainRequest, PriceExplanation
- `health.py` - HealthResponse
- `optimization.py` - PriceDemandPoint, OptimizationResult
- `pricing.py` - PricingResult
- `segment.py` - SegmentResult, SegmentDetails
- `sensitivity.py` - ScenarioResult, ConfidenceBand, SensitivityResult, SensitivityResponse
- `rules/engine.py` - AppliedRule, RulesResult

### Relevant Source Tree

```
packages/shared/src/
├── schemas/                          # NEW: Create this directory
│   ├── index.ts                      # Central exports
│   ├── common.ts                     # ErrorResponse
│   ├── market.ts                     # MarketContext
│   ├── segment.ts                    # SegmentResult, SegmentDetails
│   ├── rules.ts                      # AppliedRule, RulesResult
│   ├── optimization.ts               # PriceDemandPoint, OptimizationResult
│   ├── pricing.ts                    # PricingResult
│   ├── chat.ts                       # Chat schemas
│   ├── explainability.ts             # Feature schemas
│   ├── decision-trace.ts             # Trace schemas
│   ├── explanation.ts                # PriceExplanation
│   ├── evidence.ts                   # ModelCard, DataCard, etc.
│   ├── sensitivity.ts                # Sensitivity schemas
│   ├── health.ts                     # HealthResponse
│   └── data.ts                       # PriceRange, DataSummary
│   └── __tests__/                    # Schema tests
├── types/                            # EXISTING: Update to re-export
│   └── index.ts                      # Re-export from schemas
└── index.ts                          # Update exports

frontend/src/
├── lib/
│   └── api-client.ts                 # NEW: Validated fetch utilities
├── services/
│   └── chatService.ts                # UPDATE: Use validated client
└── stores/
    └── contextStore.ts               # UPDATE: Use schema types
```

### Current Issues to Fix

| Location | Issue |
|----------|-------|
| `packages/shared/src/types/market.ts` | ❌ COMPLETELY DIFFERENT from backend - wrong field names |
| `packages/shared/src/types/pricing.ts` | ❌ Doesn't match backend PricingResult |
| `packages/shared/src/types/chat.ts` | ⚠️ Partial match, missing streaming types |
| `frontend/src/stores/contextStore.ts` | ✅ Correct - matches backend |
| `frontend/src/components/evidence/types.ts` | ⚠️ Partial match, some fields differ |
| `frontend/src/components/visualizations/types.ts` | ⚠️ Partial match, structure differs |
| `frontend/src/services/chatService.ts` | ❌ Inline types, doesn't match backend |

### Package.json Export Update

```json
{
  "exports": {
    ".": { "types": "./src/index.ts", "default": "./src/index.ts" },
    "./types": { "types": "./src/types/index.ts", "default": "./src/types/index.ts" },
    "./schemas": { "types": "./src/schemas/index.ts", "default": "./src/schemas/index.ts" },
    "./constants": { "types": "./src/constants/index.ts", "default": "./src/constants/index.ts" }
  }
}
```

## Testing

### Test Location
- Schema tests: `packages/shared/src/schemas/__tests__/*.test.ts`
- Run with: `cd packages/shared && bun test`

### Test Standards
- Use Bun's built-in test runner
- Test both valid and invalid inputs for each schema
- Test edge cases for numeric constraints (min, max)
- Test enum validation rejects invalid values
- Test nested schema composition

### Example Test Pattern

```typescript
// packages/shared/src/schemas/__tests__/market.test.ts
import { describe, it, expect } from 'bun:test';
import { MarketContextSchema } from '../market';

describe('MarketContextSchema', () => {
  const validContext = {
    number_of_riders: 50,
    number_of_drivers: 25,
    location_category: 'Urban',
    customer_loyalty_status: 'Gold',
    number_of_past_rides: 10,
    average_ratings: 4.5,
    time_of_booking: 'Evening',
    vehicle_type: 'Premium',
    expected_ride_duration: 30,
    historical_cost_of_ride: 35.0,
  };

  it('validates correct input', () => {
    expect(() => MarketContextSchema.parse(validContext)).not.toThrow();
  });

  it('rejects number_of_riders > 100', () => {
    const invalid = { ...validContext, number_of_riders: 200 };
    expect(() => MarketContextSchema.parse(invalid)).toThrow();
  });

  it('rejects invalid location_category', () => {
    const invalid = { ...validContext, location_category: 'Downtown' };
    expect(() => MarketContextSchema.parse(invalid)).toThrow();
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-03 | 1.0 | Initial story creation from Zod validation plan | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)

